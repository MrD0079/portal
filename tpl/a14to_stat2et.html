<h1>Стандарт - Статистика</h1>
{if not $smarty.request.print}
	<form target="_self" method="POST" name=form_report id=form_report>
	<p>
	Дата
	с
	<input id=sd name=sd class=datepicker value='{$smarty.request.sd}'>
	по
	<input id=ed name=ed class=datepicker value='{$smarty.request.ed}'>
	</p>

	{if $is_ts neq 1 and $is_eta neq 1}
		<p>
		По руководителю:
		<select name=exp_list_without_ts id=exp_list_without_ts>
			<option value=0></option>
			{foreach key=key item=item from=$exp_list_without_ts}
			<option value={$item.emp_svid}><b>{$item.emp_name}</b> ({$item.emp_pos}) {if $item.datauvol}уволен {$item.datauvol}{/if}</option>
			{/foreach}
		</select>
		</p>
		<p>
		По супервайзеру:
		<select name=exp_list_only_ts id=exp_list_only_ts>
			<option value=0></option>
			{foreach key=key item=item from=$exp_list_only_ts}
			<option value={$item.emp_svid}><b>{$item.emp_name}</b> ({$item.emp_pos}) {if $item.datauvol}уволен {$item.datauvol}{/if}</option>
			{/foreach}
		</select>
		<script>$("#exp_list_without_ts option[value={$smarty.request.exp_list_without_ts}]").prop('selected', true);</script>
		<script>$("#exp_list_only_ts option[value={$smarty.request.exp_list_only_ts}]").prop('selected', true);</script>
		</p>
	{/if}
	{if $is_eta neq 1}
		<p>
		По ЭТА:
		<select name=eta_list id=eta_list>
			<option value=""></option>
			{foreach key=key item=item from=$eta_list}
			<option value="{$item.h_eta}">{$item.eta}</option>
			{/foreach}
		</select>
		<script>$("#eta_list option[value='{$smarty.request.eta_list}']").prop('selected', true);</script>
		</p>
	{/if}
	<table border=0>
		<tr>
			<td><input type=radio id="ok_ts" name="ok_ts" value=1>все
			<input type=radio id="ok_ts" name="ok_ts" value=2>проверил ТС
			<input type=radio id="ok_ts" name="ok_ts" value=3>не проверил ТС</td>
		</tr>
		<script>$("input[name=ok_ts][value={$smarty.request.ok_ts}]").attr('checked',true);</script>
		<tr>
			<td><input type=radio id="ok_auditor" name="ok_auditor" value=1>все
			<input type=radio id="ok_auditor" name="ok_auditor" value=2>проверил аудитор
			<input type=radio id="ok_auditor" name="ok_auditor" value=3>не проверил аудитор</td>
		</tr>
		<script>$("input[name=ok_auditor][value={$smarty.request.ok_auditor}]").attr('checked',true);</script>
		<tr>
			<td><input type=radio id="st_ts" name="st_ts" value=1>все
			<input type=radio id="st_ts" name="st_ts" value=2>соответствует стандарту - ТС
			<input type=radio id="st_ts" name="st_ts" value=3>не соответствует стандарту - ТС</td>
		</tr>
		<script>$("input[name=st_ts][value={$smarty.request.st_ts}]").attr('checked',true);</script>
		<tr>
			<td><input type=radio id="st_auditor" name="st_auditor" value=1>все
			<input type=radio id="st_auditor" name="st_auditor" value=2>соответствует стандарту - аудитор
			<input type=radio id="st_auditor" name="st_auditor" value=3>не соответствует стандарту - аудитор</td>
		</tr>
		<script>$("input[name=st_auditor][value={$smarty.request.st_auditor}]").attr('checked',true);</script>
		<tr>
			<td><input type=radio id="by_who" name="by_who" value='eta' onClick='$("input[name=rep_type][value=detailed]").attr("disabled",false);'>по ЭТА
			<input type=radio id="by_who" name="by_who" value='ts' onClick='$("input[name=rep_type][value=detailed]").attr("disabled",false);'>по ТС
			<input type=radio id="by_who" name="by_who" value='tm' onClick='$("input[name=rep_type][value=brief]").prop("checked",true);$("input[name=rep_type][value=detailed]").attr("disabled",true);'>по ТМ
			<input type=radio id="by_who" name="by_who" value='rm' onClick='$("input[name=rep_type][value=brief]").prop("checked",true);$("input[name=rep_type][value=detailed]").attr("disabled",true);'>по РМ</td>
		</tr>
		<script>$("input[name=by_who][value={$smarty.request.by_who}]").attr('checked',true);</script>
		<tr>
			<td><input type=radio id="rep_type" name="rep_type" value='brief'>краткий
			<input type=radio id="rep_type" name="rep_type" value='detailed' {if $smarty.request.by_who eq 'tm'}disabled{/if}>развернутый</td>
		</tr>
		<script>$("input[name=rep_type][value={$smarty.request.rep_type}]").attr('checked',true);</script>
		<tr>
			<td><input type=radio id="ok_st_tm" name="ok_st_tm" value=1>все
			<input type=radio id="ok_st_tm" name="ok_st_tm" value=2>Стандарт засчитан ТМом</td>
		</tr>
		<script>$("input[name=ok_st_tm][value={$smarty.request.ok_st_tm}]").attr('checked',true);</script>
		<tr>
			<td><input type=radio id="standart" name="standart" value=1>все
			<input type=radio id="standart" name="standart" value=2>A-стандарт
			<input type=radio id="standart" name="standart" value=3>B-стандарт</td>
		</tr>
		<script>$("input[name=standart][value={$smarty.request.standart}]").attr('checked',true);</script>
	</table>
	<p><input type=submit name=generate id=generate value="Построить отчет"></p>
	<p><input type=submit name=save id=save value="Сохранить"></p>
	<p><a href="?action=a14to_stat2et&print=1&excel=1&generate=1&filename=Стандарт - статистика">Экспорт в Excel</a></p>
{/if}

{if $smarty.request.rep_type eq 'brief'}
<table style="text-align: center;" border=1>
<tbody>
	{foreach key=k item=i from=$d name=d}
	{if $smarty.foreach.d.iteration%20 eq 1 and not ($smarty.request.print and $smarty.foreach.d.iteration > 1)}
	<tr style="font-weight: bold;">
		{if $smarty.request.by_who eq 'eta'}
		<td>т.н. ЭТА</td>
		<td>ФИО ЭТА</td>
		{/if}
		{if $smarty.request.by_who eq 'ts'}<td>т.н. ТС</td>{/if}
		{if $smarty.request.by_who eq 'eta' or $smarty.request.by_who eq 'ts'}<td>ФИО ТС</td>{/if}
		{if $smarty.request.by_who eq 'tm'}<td>т.н. ТМ</td>{/if}
		{if $smarty.request.by_who eq 'eta' or $smarty.request.by_who eq 'ts' or $smarty.request.by_who eq 'tm'}<td>ФИО ТМ</td>{/if}
		{if $smarty.request.by_who eq 'rm'}<td>т.н. РМ</td>{/if}
		{if $smarty.request.by_who eq 'eta' or $smarty.request.by_who eq 'ts' or $smarty.request.by_who eq 'tm' or $smarty.request.by_who eq 'rm'}<td>ФИО РМ</td>{/if}
		<td>Регион</td>
		<td>Всего ТП с СТО по маршруту</td>
		<td>Визитов в ТП с СТО по маршруту</td>
		<td>Совершено визитов</td>
		<td>Стеллажи</td>
		<td>Витрины</td>
		<td>ИТОГО СТО</td>
		<td>Стандарт фото - ТС</td>
                <td>отклонено (ТМ, ВСТМ)</td>
		<td>% ТО со стандартом ТС</td>
		<td>Не проверено - ТС (фото)</td>
		<td>План АКБ</td>
		<td>% покрытия СТО</td>
		<td>% фотоотчетов</td>
		<td>Стандарт по ТП</td>
		{if $smarty.request.by_who neq 'tm'}
		<td style="font-weight: bold; background-color: rgb(255, 204, 153);">Сумма бонуса, {$valuta}</td>
		{/if}
	</tr>
	{/if}
	<tr>
		{if $smarty.request.by_who eq 'eta'}
		<td style="text-align: left;">{$i.t.eta_tab_number}</td>
		<td style="text-align: left;">{$i.t.fio_eta}</td>
		{/if}
		{if $smarty.request.by_who eq 'ts'}<td style="text-align: left;">{$i.t.tab_num_ts}</td>{/if}
		{if $smarty.request.by_who eq 'eta' or $smarty.request.by_who eq 'ts'}<td style="text-align: left;">{$i.t.fio_ts}</td>{/if}
		{if $smarty.request.by_who eq 'tm'}<td style="text-align: left;">{$i.t.tab_num_tm}</td>{/if}
		{if $smarty.request.by_who eq 'eta' or $smarty.request.by_who eq 'ts' or $smarty.request.by_who eq 'tm'}<td style="text-align: left;">{$i.t.fio_tm}</td>{/if}
		{if $smarty.request.by_who eq 'rm'}<td style="text-align: left;">{$i.t.tab_num_rm}</td>{/if}
		{if $smarty.request.by_who eq 'eta' or $smarty.request.by_who eq 'ts' or $smarty.request.by_who eq 'tm' or $smarty.request.by_who eq 'rm'}<td style="text-align: left;">{$i.t.fio_rm}</td>{/if}
		<td>{$i.t.region_name}</td>
		<td>{$i.t.tp_cnt}</td>
		<td>{$i.t.visit_plan}</td>
		<td>{$i.t.visit_fakt}</td>
		<td>{$i.t3.stelag}</td>
		<td>{$i.t3.tumb}</td>
		<td>{$i.t3.sto_total}</td>
		<td>{$i.t1.ts1}</td>
                <td></td>
		<td>{$i.t1.perc_ts|num:2}</td>
		<td>{$i.t1.tsnull}</td>
		<td>{$i.t2.value|num:2}</td>
		<td>{$i.t2.perc_pokr_sto|num:2}</td>
		<td>{$i.t.perc_photo_rep|num:2}</td>
		<td>{$i.t.sttotp}</td>
		{if $smarty.request.by_who neq 'tm'}
		<td style="font-weight: bold; background-color: rgb(255, 204, 153);">{$i.t3.bonus4tp|num:2}</td>
		{/if}
	</tr>
	{/foreach}
	<tr style="font-weight: bold;">
		{if $smarty.request.by_who eq 'eta'}<td colspan=6>ИТОГО</td>{/if}
		{if $smarty.request.by_who eq 'ts'}<td colspan=5>ИТОГО</td>{/if}
		{if $smarty.request.by_who eq 'tm'}<td colspan=4>ИТОГО</td>{/if}
		{if $smarty.request.by_who eq 'rm'}<td colspan=3>ИТОГО</td>{/if}
		<td>{$tt.tp_cnt}</td>
		<td>{$tt.visit_plan}</td>
		<td>{$tt.visit_fakt}</td>
		<td>{$tt3.stelag}</td>
		<td>{$tt3.tumb}</td>
		<td>{$tt3.sto_total}</td>
		<td>{$tt1.ts1}</td>
                <td></td>
		<td>{$tt1.perc_ts|num:2}</td>
		<td>{$tt1.tsnull}</td>
		<td>{$tt2.value|num:2}</td>
		<td>{$tt2.perc_pokr_sto|num:2}</td>
		<td>{$tt.perc_photo_rep|num:2}</td>
		<td>{$tt.sttotp}</td>
		{if $smarty.request.by_who neq 'tm'}
		<td style="font-weight: bold; background-color: rgb(255, 204, 153);">{$tt3.bonus4tp|num:2}</td>
		{/if}
	</tr>
</tbody>
</table>
{/if}
{if $smarty.request.rep_type eq 'detailed'}
<table style="text-align: center;" border=1>
<tbody>
	{foreach key=k item=i from=$d name=d}
	{if $smarty.foreach.d.iteration%20 eq 1 and not ($smarty.request.print and $smarty.foreach.d.iteration > 1)}
	<tr style="font-weight: bold;">
		{if $smarty.request.by_who eq 'eta'}
		<td>т.н. ЭТА</td>
		<td>ФИО ЭТА</td>
		{/if}
		{if $smarty.request.by_who eq 'ts'}
		<td>т.н. ТС</td>
		{/if}
		<td>ФИО ТС</td>
		<td>ФИО ТМ</td>
		<td>ФИО РМ</td>
		<td>Код ТП</td>
		<td>Название ТП</td>
		<td>Адрес ТП</td>
		<td>Тип ТП</td>
		<td>Стеллажи</td>
		<td>Витрины</td>
		<td>Визиты ПЛАН</td>
		<td>Визиты ФАКТ</td>
		<td>Количество стандартов по визитам</td>
		<td>Стандарт по ТП / Засчитать стандарт</td>
		<td>Комментарии по засчитыванию стандарта</td>
		<td>Объем продаж в месяц, {$valuta}</td>
		<td style="background-color: rgb(255, 204, 153);">Стоимость стандарта, {$valuta}</td>
		<td style="font-weight: bold; background-color: rgb(255, 204, 153);">Бонус за ТП, {$valuta}</td>
                <td>Тип стандарта</td>
	</tr>
	{/if}
	<tr>
		{if $smarty.request.by_who eq 'eta'}
		<td style="text-align: left;">{$i.eta_tab_number}</td>
		<td style="text-align: left;">{$i.fio_eta}</td>
		{/if}
		{if $smarty.request.by_who eq 'ts'}
		<td style="text-align: left;">{$i.tab_num_ts}</td>
		{/if}
		<td style="text-align: left;">{$i.fio_ts}</td>
		<td style="text-align: left;">{$i.fio_tm}</td>
		<td style="text-align: left;">{$i.fio_rm}</td>
		<td style="text-align: left;">{$i.tp_kod_key}</td>
		<td style="text-align: left;">{$i.tp_ur}</td>
		<td style="text-align: left;">{$i.tp_addr}</td>
		<td style="text-align: left;">{$i.tp_type_short}</td>
		<td>{$i.stelag}</td>
		<td>{$i.tumb}</td>
		<td>{$i.visit_plan}</td>
		<td>{$i.visit_fakt}</td>
		<td>{$i.ts1}</td>
		<td>
			<b><!--if $i.visit_plan eq $i.ts1 or $i.zst_lu-->{if $i.zst_lu}да{else}нет{/if}</b>
			{if not $smarty.request.print}
			{if $i.visit_plan eq $i.ts1}
				<!--<input id=zst_{$i.tp_kod_key} type=hidden value=1 name=data[{$i.tp_kod_key}][zst]>-->
			{else}
				{if ($is_tm eq 1 and not $i.zst_lu) or ($is_admin eq 1 and $i.zst_lu)}
				<input id=cb1_{$i.tp_kod_key} type=checkbox {if $i.zst_lu}checked{/if} onChange="
				$('#ta1_{$i.tp_kod_key}').attr('disabled',!this.checked);
				$('#zst_{$i.tp_kod_key}').val(this.checked?1:0);
				">
				<input id=zst_{$i.tp_kod_key} type=hidden value='{if $i.zst_lu}1{/if}' name=data[{$i.tp_kod_key}][zst]>
				{/if}
			{/if}
			{/if}
			{if not $smarty.request.print}<br>{$i.zst_lu_fio}<br>{$i.zst_lu}{/if}
		</td>
		<td>
		{if not $smarty.request.print}
			{if $i.visit_plan neq $i.ts1}<textarea required name=data[{$i.tp_kod_key}][comm] id=ta1_{$i.tp_kod_key} {if not $i.zst_lu}disabled{/if}>{$i.zst_comm}</textarea>{/if}
			{else}
			{$i.zst_comm}
			{/if}</td>
		<td>{$i.summa|default:0|num:2}</td>
		<td style="background-color: rgb(255, 204, 153);">{$i.standart_price|default:0|num:2}</td>
		<td style="font-weight: bold; background-color: rgb(255, 204, 153);">{$i.bonus4tp|default:0|num:2}</td>
                <td>{$i.standart}</td>
	</tr>
	{/foreach}
	<tr style="font-weight: bold;">
		<td colspan="{if $smarty.request.by_who eq 'eta'}9{else}8{/if}">ИТОГО</td>
		<td>{$tt3.stelag}</td>
		<td>{$tt3.tumb}</td>
		<td>{$tt.visit_plan}</td>
		<td>{$tt.visit_fakt}</td>
		<td>{$tt1.ts1}</td>
		<td>{$tt.sttotp}</td>
		<td></td>
		<td>{$tt2.summa|num:2}</td>
		<td style="background-color: rgb(255, 204, 153);"></td>
		<td style="font-weight: bold; background-color: rgb(255, 204, 153);">{$tt3.bonus4tp|num:2}</td>
                <td></td>
	</tr>
</tbody>
</table>
{/if}

{if not $smarty.request.print}
</form>
{/if}