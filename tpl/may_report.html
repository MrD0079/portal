<h1>
{if $smarty.request.giveup eq 1}
Выдача подарков
{elseif $smarty.request.giveup_check eq 1}
Контроль выдачи подарков
{else}
Общий отчет
{/if}
 по акции "МаЕвка"
</h1>


{if not $smarty.request.print}

<form target="_self" method="POST" name=form_report id=form_report>


{if $is_ts neq 1}



По руководителю:
<br>
<select name=exp_list_without_ts id=exp_list_without_ts onchange="javascript:fn_submit('exp_list_without_ts');">
<option value=0></option>
{foreach key=key item=item from=$exp_list_without_ts}
<option value={$item.emp_svid}><b>{$item.emp_name}</b> ({$item.emp_pos}) {if $item.datauvol}уволен {$item.datauvol}{/if}</option>
{/foreach}
</select>


<br>

По супервайзеру:
<br>
<select name=exp_list_only_ts id=exp_list_only_ts onchange="javascript:fn_submit('exp_list_only_ts');">
<option value=0></option>
{foreach key=key item=item from=$exp_list_only_ts}
<option value={$item.emp_svid}><b>{$item.emp_name}</b> ({$item.emp_pos}) {if $item.datauvol}уволен {$item.datauvol}{/if}</option>
{/foreach}
</select>

<br>

<script>$("#exp_list_without_ts option[value={$smarty.request.exp_list_without_ts}]").prop('selected', true);</script>
<script>$("#exp_list_only_ts option[value={$smarty.request.exp_list_only_ts}]").prop('selected', true);</script>


<input type="hidden" name="form_submit" id=form_submit>

{literal}
<script>
function fn_submit(val)
{
	$('#form_submit').val(val);
	$('#form_report').submit();
}
</script>
{/literal}

{/if}

{if $smarty.request.giveup}
	Подарок выдан ТС:
	<br>
	<input type=radio id="ok_ts" name="ok_ts" value=1>все
	<input type=radio id="ok_ts" name="ok_ts" value=2>выдан ТС
	<input type=radio id="ok_ts" name="ok_ts" value=3>не выдан ТС
	<br>
<script>$("input[name=ok_ts][value={$smarty.request.ok_ts|default:1}]").attr('checked',true);</script>
<br>
	Выдача бонуса подтверждена руководителем:
	<br>
	<input type=radio id="ok_chief" name="ok_chief" value=1>все
	<input type=radio id="ok_chief" name="ok_chief" value=2>подтверждено руководителем
	<input type=radio id="ok_chief" name="ok_chief" value=3>не подтверждено руководителем
	<br>
<script>$("input[name=ok_chief][value={$smarty.request.ok_chief|default:1}]").attr('checked',true);</script>

{else}
	Подтверждение ВСТМ:
	<br>
	<input type=radio id="ok_traid" name="ok_traid" value=1>все
	<input type=radio id="ok_traid" name="ok_traid" value=2>подтверждено ВСТМ
	<input type=radio id="ok_traid" name="ok_traid" value=3>не подтверждено ВСТМ
	<br>
<script>$("input[name=ok_traid][value={$smarty.request.ok_traid|default:1}]").attr('checked',true);</script>
{/if}


<br>
<br>
<input type=submit name=save id=save class=save value="Сохранить">
<br>


<a href="?action=may_report{if $smarty.request.giveup eq 1}&giveup=1{/if}{if $smarty.request.giveup_check eq 1}&giveup_check=1{/if}&print=1&excel=1&filename={if $smarty.request.giveup eq 1}Выдача подарков{elseif $smarty.request.giveup_check eq 1}Контроль выдачи подарков{else}Общий отчет{/if} по акции королевский опт">Экспорт в Excel</a>


{if $is_traid}
{literal}
<a href="javascript:void(0);" onclick="$('.chk_all:enabled').each(function(){$(this).prop('checked',false);$(this).click();});">[+]</a>
<a href="javascript:void(0);" onclick="$('.chk_all:enabled').each(function(){$(this).prop('checked',true);$(this).click();});">[-]</a>
{/literal}
{/if}


{/if}



<table border=1 cellspacing=0 cellpadding=3 width=1000px>
	<tr style="font-weight:bold">
		<td>№<br>п/п</td>
		<td>ТС</td>
		<td>Прямой руководитель ТС-а</td>
		<td>ФИО ЭТА</td>
		<td>Название ТП</td>
		<td>Адрес ТП</td>

		<td>Дата акционной накладной</td>

		<td>Тип акции</td>
		<td>Сумма акционной накладной, {$valuta}.</td>
		<td>Сумма бонуса расчетная, {$valuta}.</td>
		<td>Сумма бонуса фактическая, {$valuta}.</td>
		<td>Затратная часть, %</td>

		{if $smarty.request.giveup or $smarty.request.giveup_check}
			<td>Подарок выдан</td>
			{if $smarty.request.giveup}
				<td>Выдачу<br>подарка<br>подтверждаю</td>
			{/if}
			<td>Телефон ЛПР</td>
		{else}
			<td>Подтверждаю ВСТМ</td>
		{/if}
		{if $smarty.request.giveup_check}
			<td>Проверено РМ/БТ</td>
			<td>Проверено руководство/аудит</td>
		{/if}
	</tr>
	{foreach key=list_key item=list_item from=$list name=list}
	<tr bgcolor="{cycle values="#ccffff,#ffffcc"}">
		<td>{$smarty.foreach.list.iteration}</td>
		<td>{$list_item.fio_ts}</td>
		<td>{$list_item.parent_fio}</td>
		<td>{$list_item.fio_eta}</td>
		<td>{$list_item.tp_ur}</td>
		<td>{$list_item.tp_addr}</td>

		<td>{$list_item.data}</td>

		<td>{$list_item.type}</td>


		<td style="text-align:right">{$list_item.summa|default:0|num:2}</td>
		<td style="text-align:right">{$list_item.bonus_plan|default:0|num:2}</td>
		<td style="text-align:right">{$list_item.bonus|default:0|num:2}</td>

		<td style="text-align:right">{$list_item.perc|default:0|num:2}</td>

		{if $smarty.request.giveup or $smarty.request.giveup_check}
		<td {if $list_item.ok_ts eq 1}bgcolor="#00ff00"{/if}>
			{if $smarty.request.giveup_check or $smarty.request.print}
				{if $list_item.ok_ts eq 1}да{/if} {$list_item.ok_ts_date}
			{else}
			<input type="checkbox"
			onclick="javascript:check_item('ok',{$list_item.id},'{$list_item.id}','{$list_item.id}','ok_ts',this.checked,'ok_ts_date')"
			{if $list_item.ok_ts eq 1}checked{/if}
			{if not $list_item.ok_traid or not $is_ts or $list_item.svideninn neq $tn or $list_item.ok_chief eq 1}disabled{/if}
			>
			Дата
			<input class="datepicker" name=date[ok_ts_date][{$list_item.id}][{$list_item.id}][{$list_item.id}] size=11
			{if not $list_item.ok_ts or not $list_item.ok_traid or not $is_ts or $list_item.svideninn neq $tn or $list_item.ok_chief eq 1}disabled{/if}
			required value="{$list_item.ok_ts_date}"
			>
			<input type=hidden name=ok[ok_ts][{$list_item.id}][{$list_item.id}][{$list_item.id}]>
			{/if}
		</td>
		{if $smarty.request.giveup}
		<td>
			{if $smarty.request.print}
			{if $list_item.ok_chief eq 1}да{/if}
			{else}
			<input type="checkbox"
			onclick="javascript:check_item('ok',{$list_item.id},'{$list_item.id}','{$list_item.id}','ok_chief',this.checked)"
			{if $list_item.ok_chief eq 1}checked{/if}
			{if not $list_item.ok_traid or $list_item.ok_ts neq 1 or $list_item.parent_tn neq $tn}disabled{/if}>
			{$list_item.parent_fio}
			<input type=hidden name=ok[ok_chief][{$list_item.id}][{$list_item.id}][{$list_item.id}]>
			{/if}
		</td>
		{/if}
		<td>{$list_item.contact_lpr|escape}</td>
		{else}
		<td style="text-align:center">
			{if $smarty.request.print}
			{if $list_item.ok_traid eq 1}да{/if}
			{else}
			<input
				class="chk_all"
				name="cb_traid[]"
				type=checkbox
				onclick="javascript:check_item('ok',{$list_item.id},'{$list_item.id}','{$list_item.id}','ok_traid',this.checked)"
				{if $list_item.ok_traid eq 1}checked{/if}
				{if not $is_traid or $list_item.ok_ts eq 1 or $list_item.ok_chief eq 1}disabled{/if}
			>
			{if $list_item.ok_traid eq 1}да{/if}{if $list_item.ok_traid eq '0'}нет{/if}
			<input type=hidden name=ok[ok_traid][{$list_item.id}][{$list_item.id}][{$list_item.id}]>
			{/if}
		</td>
		{/if}
		{if $smarty.request.giveup_check}
			<td
				{if $list_item.ok_ts_exp_not_full eq 1}bgcolor="#00ff00"{/if}
			>
{if not $smarty.request.print}
				<input	type=checkbox
					onclick="javascript:check_item('ok',{$list_item.id},'{$list_item.id}','{$list_item.id}','ok_ts_exp_not_full',this.checked,'ok_ts_exp_not_full_date')"
					{if $list_item.ok_ts_exp_not_full eq 1}checked{/if}
					{if $list_item.ts_exp_not_full neq $tn}disabled{/if}
				>
				Дата
				<input class="datepicker" size=11 required
					name=date[ok_ts_exp_not_full_date][{$list_item.id}][{$list_item.id}][{$list_item.id}]
					{if not $list_item.ok_ts_exp_not_full eq 1 or $list_item.ts_exp_not_full neq $tn}disabled{/if}
					value="{$list_item.ok_ts_exp_not_full_date}"
				>
			<input type=hidden name=ok[ok_ts_exp_not_full][{$list_item.id}][{$list_item.id}][{$list_item.id}]>
			<input type=hidden name=ok_tn[ok_ts_exp_not_full_tn][{$list_item.id}][{$list_item.id}][{$list_item.id}]>
{else}
				{if $list_item.ok_ts_exp_not_full eq 1}да {$list_item.ok_ts_exp_not_full_date}{/if}
{/if}
				{$list_item.ok_ts_exp_not_full_name}
			</td>
			<td
				{if $list_item.ok_super eq 1}bgcolor="#00ff00"{/if}
			>
{if not $smarty.request.print}
				<input type=checkbox
					onclick="javascript:check_item('ok',{$list_item.id},'{$list_item.id}','{$list_item.id}','ok_super',this.checked,'ok_super_date')"
					{if $list_item.ok_super eq 1}checked{/if}
					{if not $is_super}disabled{/if}
				>
				Дата
				<input class="datepicker" size=11 required
					name=date[ok_super_date][{$list_item.id}][{$list_item.id}][{$list_item.id}]
					{if not $list_item.ok_super eq 1 or not $is_super}disabled{/if}
					value="{$list_item.ok_super_date}"
				>
			<input type=hidden name=ok[ok_super][{$list_item.id}][{$list_item.id}][{$list_item.id}]>
			<input type=hidden name=ok_tn[ok_super_tn][{$list_item.id}][{$list_item.id}][{$list_item.id}]>
{else}
				{if $list_item.ok_super eq 1}да {$list_item.ok_super_date}{/if}
{/if}
				{$list_item.ok_super_name}
			</td>
		{/if}
	</tr>
	{/foreach}
	{foreach key=list_key item=list_item from=$list_total name=list_total}
	<tr style="font-weight:bold">


		


		<td colspan={if $smarty.request.giveup or $smarty.request.giveup_check}7{else}8{/if}>Итого ТП: {$list_item.c1|default:0}</td>



		<td style="text-align:right">{$list_item.summa|default:0|num:2}</td>
		<td style="text-align:right">{$list_item.bonus_plan|default:0|num:2}</td>
		<td style="text-align:right">{$list_item.bonus|default:0|num:2}</td>

		<td style="text-align:right">{$list_item.perc|default:0|num:2}</td>



		{if $smarty.request.giveup or $smarty.request.giveup_check}
		<td style="text-align:right">{$list_item.ok_ts|default:0}</td>
		{if $smarty.request.giveup}
		<td style="text-align:right">{$list_item.ok_chief|default:0}</td>
		{/if}
		<td></td>
		{else}
		<td style="text-align:right">{$list_item.ok_traid|default:0}</td>
		{/if}


















	</tr>
	{/foreach}
</table>



<h2>
{if $smarty.request.giveup or $smarty.request.giveup_check}
Итоги акции по ТП, получившим подарки
{else}
Итоги акции по ТП, подтвержденным ВСТМ
{/if}
</h2>


<table border=1 cellspacing=0 cellpadding=3 width=1000px>
	<tr style="font-weight:bold">
		<td>Всего<br>ТП</td>
		<td>Сумма по акционным накладным, {$valuta}.</td>
		<td>Сумма бонуса расчетная, {$valuta}.</td>
		<td>Сумма бонуса фактическая, {$valuta}.</td>
		<td>Затраты на акцию, %</td>
	</tr>
	{foreach key=list_key item=list_item from=$list_total_itogi name=list_total_itogi}
	<tr>
		<td style="text-align:right">{$list_item.c1|default:0}</td>
		<td style="text-align:right">{$list_item.summa|default:0|num:2}</td>
		<td style="text-align:right">{$list_item.bonus_plan|default:0|num:2}</td>
		<td style="text-align:right">{$list_item.bonus|default:0|num:2}</td>
		<td style="text-align:right">{$list_item.perc|default:0|num:2}</td>
	</tr>
	{/foreach}
</table>





<h2>Сканкопии акционных накладных</h2>

<table border=1 cellspacing=0 cellpadding=3>
	<tr style="font-weight:bold">
		<td>ФИО ТС</td>
		<td>Название файла-сканкопии</td>
		<td>Подтверждено ВСТМ</td>
	</tr>
	{foreach key=key item=item from=$file_list_b}
	{foreach key=file_list_key item=file_list_item from=$item.data}
	<tr style="text-align:center" bgcolor="{cycle values="#ccffff,#ffffcc"}">
		<td style="text-align:left">{$file_list_item.fio_ts}</td>
		<td>
		{if not $smarty.request.print}
			<a target=_blank href="may_files/{$file_list_item.tn}/{$file_list_item.tip}/{$file_list_item.fn}">{$file_list_item.fn}</a>
		{else}
			{$file_list_item.fn}
		{/if}
		</td>
		<td style="text-align:center" {if $file_list_item.ok_traid eq '1'}bgcolor="#00ff00"{/if}>
		{if not $smarty.request.print}
			<input
				class="chk_all"
				name="cb_traid[]"
				type=checkbox
				onclick="javascript:check_item('ok_files',{$file_list_item.id},'{$file_list_item.id}','{$file_list_item.id}','ok_traid',this.checked)"
				{if $file_list_item.ok_traid eq 1}checked{/if}
				{if not $is_traid or $file_list_item.ok_ts eq 1 or $file_list_item.ok_chief eq 1}disabled{/if}
			>
			{if $file_list_item.ok_traid eq 1}да{/if}{if $file_list_item.ok_traid eq '0'}нет{/if}
			<input type=hidden name=ok_files[ok_traid][{$file_list_item.id}][{$file_list_item.id}][{$file_list_item.id}]>
		{else}
			{if $file_list_item.ok_traid eq 1}да{/if}
		{/if}
		</td>
	</tr>
	{/foreach}
	<tr style="text-align:center;font-weight:bold" bgcolor="{cycle values="#ccffff,#ffffcc"}">
		<td style="text-align:left" colspan=3>Итого файлов: {$item.data_total.c1}</td>
	</tr>
	{/foreach}
	<tr style="text-align:center;font-weight:bold" bgcolor="green">
		<td style="text-align:left" colspan=3>Итого файлов по всем ТС: {$file_list_b_total.c1}</td>
	</tr>
</table>

<h2>Сканкопии бонусных накладных</h2>

<table border=1 cellspacing=0 cellpadding=3>
	<tr style="font-weight:bold">
		<td>ФИО ТС</td>
		<td>Название файла-сканкопии</td>
		<td>Подтверждено ВСТМ</td>
	</tr>
	{foreach key=key item=item from=$file_list_c}
	{foreach key=file_list_key item=file_list_item from=$item.data}
	<tr style="text-align:center" bgcolor="{cycle values="#ccffff,#ffffcc"}">
		<td style="text-align:left">{$file_list_item.fio_ts}</td>
		<td>
		{if not $smarty.request.print}
			<a target=_blank href="may_files/{$file_list_item.tn}/{$file_list_item.tip}/{$file_list_item.fn}">{$file_list_item.fn}</a>
		{else}
			{$file_list_item.fn}
		{/if}
		</td>
		<td style="text-align:center" {if $file_list_item.ok_traid eq '1'}bgcolor="#00ff00"{/if}>
		{if not $smarty.request.print}
			<input
				class="chk_all"
				name="cb_traid[]"
				type=checkbox
				onclick="javascript:check_item('ok_files',{$file_list_item.id},'{$file_list_item.id}','{$file_list_item.id}','ok_traid',this.checked)"
				{if $file_list_item.ok_traid eq 1}checked{/if}
				{if not $is_traid or $file_list_item.ok_ts eq 1 or $file_list_item.ok_chief eq 1}disabled{/if}
			>
			{if $file_list_item.ok_traid eq 1}да{/if}{if $file_list_item.ok_traid eq '0'}нет{/if}
			<input type=hidden name=ok_files[ok_traid][{$file_list_item.id}][{$file_list_item.id}][{$file_list_item.id}]>
		{else}
			{if $file_list_item.ok_traid eq 1}да{/if}
		{/if}
		</td>
	</tr>
	{/foreach}
	<tr style="text-align:center;font-weight:bold" bgcolor="{cycle values="#ccffff,#ffffcc"}">
		<td style="text-align:left" colspan=3>Итого файлов: {$item.data_total.c1}</td>
	</tr>
	{/foreach}
	<tr style="text-align:center;font-weight:bold" bgcolor="green">
		<td style="text-align:left" colspan=3>Итого файлов по всем ТС: {$file_list_c_total.c1}</td>
	</tr>
</table>

















{if not $smarty.request.print}





<br>
<br>
<input type=submit name=save id=save class=save value="Сохранить">
<br>
<br>

</form>














{literal}
<script>
function check_item($ok,$k1,$k2,$k3,$e,$sck,$date)
{
	var hd = document.forms["form_report"].elements[""+$ok+"["+$e+"]["+$k1+"]["+$k2+"]["+$k3+"]"];
	if ($date)
	{
		var date = document.forms["form_report"].elements["date["+$date+"]["+$k1+"]["+$k2+"]["+$k3+"]"];
		var tn = document.forms["form_report"].elements["ok_tn["+$e+"_tn]["+$k1+"]["+$k2+"]["+$k3+"]"];
	}
	if ($sck)
	{
		hd.value=1;
		if ($date)
		{
			date.disabled=false;
		}
		if (tn) tn.value={/literal}{$tn}{literal};
	}
	else
	{
		hd.value=0;
		if ($date)
		{
			date.value="";
			date.disabled=true;
			if (tn) tn.value="";
		}
	}
}
</script>
{/literal}

{/if}