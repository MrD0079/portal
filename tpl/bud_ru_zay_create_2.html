{if $smarty.request.getProductList}
    <option></option>
    {foreach key=k item=i from=$x name=x}
    <option value="{$i.id}">{$i.name}</option>
    {/foreach}
{else if $smarty.request.getProduct}
        <tr id=tp_{$x.id}>
            <td><input type="button" value="удалить" onClick="$('#tp_{$x.id}').remove();$('#productList option[value={$x.id}]').attr('disabled', false);"></td>
            <!--1--><td><input name="productList[{$x.id}][product_brand]" type="hidden" id="f1_{$x.id}" value="{$x.product_brand}">{$x.product_brand}</td>
            <!--2--><td><input name="productList[{$x.id}][product_name_sw]" type="hidden" id="f2_{$x.id}" value="{$x.product_name_sw}"><nobr>{$x.product_name_sw}</nobr></td>
            <!--3--><td style="text-align: right"><input name="productList[{$x.id}][product_weight]" type="hidden" id="f3_{$x.id}" value="{$x.product_weight}">{$x.product_weight|num:3}</td>
            <!--4--><td><input name="productList[{$x.id}][compens_perc]" class="number_int" size="5" id="f4_{$x.id}" onChange="changeRow({$x.id})"></td>
            <!--5--><td style="text-align: right"><input name="productList[{$x.id}][price_spec]" type="hidden" id="f5_{$x.id}" value="{$x.price}">{$x.price|num:2}</td>
            <!--6--><td><input name="productList[{$x.id}][price_net]" class="number" size="5" id="f6_{$x.id}" onChange="changeRow({$x.id})"></td>
            <!--7--><td style="text-align: right"><input name="productList[{$x.id}][price_wo_nds]" type="hidden" id="f7_{$x.id}"><div id="l7_{$x.id}"></div></td>
            <!--8--><td style="text-align: right"><input name="productList[{$x.id}][plan_sales_kg]" class="f8" type="hidden" id="f8_{$x.id}"><div id="l8_{$x.id}"></div></td>
            <!--9--><td><input name="productList[{$x.id}][plan_sales_cnt]" class="number f9" size="5" id="f9_{$x.id}" onChange="changeRow({$x.id})"></td>
            <!--10--><td style="text-align: right"><input name="productList[{$x.id}][plan_ship]" class="f10" type="hidden" id="f10_{$x.id}"><div id="l10_{$x.id}"></div></td>
            <!--11--><td style="text-align: right"><input name="productList[{$x.id}][discount_expenses]" class="f11" type="hidden" id="f11_{$x.id}"><div id="l11_{$x.id}"></div></td>
            <!--12--><td><input name="productList[{$x.id}][autorization]" class="number f12" size="5" id="f12_{$x.id}" onChange="changeRow({$x.id})"></td>
            <!--13--><td style="text-align: right"><input name="productList[{$x.id}][discount]" type="hidden" id="f13_{$x.id}"><div id="l13_{$x.id}"></div></td>
            <!--14--><td style="text-align: right"><input name="productList[{$x.id}][price_prot]" type="hidden" id="f14_{$x.id}" value="{$x.price_prot}">{$x.price_prot|num:2}</td>
            <!--15--><td><input name="productList[{$x.id}][sku_id]" type="hidden" id="f15_{$x.id}" value="{$x.sku_id}">{$x.sku_id}</td>
            <!--16--><td><input name="productList[{$x.id}][tagid]" type="hidden" id="f16_{$x.id}" value="{$x.tagid}">{$x.tagid}</td>
            <!--17--><td><input name="productList[{$x.id}][product_id]" type="hidden" id="f17_{$x.id}" value="{$x.product_id}">{$x.product_id}</td>
        </tr>
{else}
    {literal}
    <script type='text/javascript'>
    $a=1;
    $cnt=0;
    $s="<option></option>{/literal}{foreach key=key item=item from=$spd_list}{if $item.tn neq $smarty.request.bud_ru.tn}<option value={$item.tn}>{$item.fio|escape} - {$item.dpt_name|escape}</option>{/if}{/foreach}{literal}";
    function add_acceptor(id)
    {
            $("<div id=\"div_bud_ru_acceptors_new"+$a+"\"><a href=\"javascript:void(0);\" onclick=\"check_required(-1);$('#bud_ru_acceptors_new"+$a+"').val(null);$('#bud_ru_acceptors_new"+$a+"').attr('disabled',true);$('#div_bud_ru_acceptors_new"+$a+"').hide();\">[X]</a></div>").insertBefore($("#ac1"));
            $("#div_bud_ru_acceptors_new"+$a).append($("<select required name=\"bud_ru_acceptors[]\" id=\"bud_ru_acceptors_new"+$a+"\">"+$s+"</select>"));
            $("#bud_ru_acceptors_new"+$a).val(id);
            $a++;
            check_required(1);
    }

    function check_required(increment)
    {
	$cnt = $cnt + increment;
//	var select = $('#bud_ru_acceptors_new' + $cnt );
//	var innEmployee = '';

//	$(select )	

	//$('#save').attr('disabled', true);
           // $cnt=$cnt+increment;
            $cnt>0 ? $("#acc").val($cnt) : $("#acc").val(null);
           // $cnt>0 ? $("#save").attr('disabled',false) : $("#save").attr('disabled',true);
    }

    function add_executor(id)
    {
            $("<div id=\"div_bud_ru_executors_new"+$a+"\"><a href=\"javascript:void(0);\" onclick=\"$('#bud_ru_executors_new"+$a+"').val(null);$('#bud_ru_executors_new"+$a+"').attr('disabled',true);$('#div_bud_ru_executors_new"+$a+"').hide();\">[X]</a></div>").insertBefore($("#exe1"));
            $("#div_bud_ru_executors_new"+$a).append($("<select required name=\"bud_ru_executors[]\" id=\"bud_ru_executors_new"+$a+"\">"+$s+"</select>"));
            $("#bud_ru_executors_new"+$a).val(id);
            $a++;
    }

	
	
	
	
    </script>
    {/literal}
	
	{if $smarty.request.for_kk == 'on'}
		{literal}
		<script>
			$(document).ready(function(){
		$('#save').click(function(e){
			var babec = false;
			var select = $('[id^="bud_ru_acceptors_new"]');
			for(var i = 0; i <= $cnt; i++){
				if( $(select[i]).val() != undefined && $(select[i]).val() === '2923402273' ){
					console.log($(select[i]).val())
					babec = true;
				}
			}
			if(babec){
				$(this).attr('disabled', false);
			}else{
				alert('Роман Бабец обязательный участник согласования заявки КК.');
			return false;
			}
		})
	})
		</script>
		{/literal}
	{/if}
    {if $smarty.request.save}
            {if $smarty.request.admin}
                    <h1>{if $smarty.request.tu eq 1}Цели на переговоры{else}Заявка на активность{/if}, документ сохранен</h1>
            {else}
                    <h1>{if $smarty.request.tu eq 1}Цели на переговоры{else}Заявка на активность{/if}</h1>
                    <p>Документ отправлен на согласование и ожидает согласования следующими сотрудниками:</p>
                    {foreach key=key item=item from=$acceptors}
                            <p>{$item.acceptor}</p>
                    {/foreach}
            {/if}
    {else}
        <h1>{if $smarty.request.tu eq 1}Цели на переговоры{else}Заявка на активность{/if}, создание (шаг 2)</h1>
        {if not $smarty.request.id}
            <a href="javascript:void(0);" onclick="goto_step1();">Вернуться на Шаг 1</a>
            <script>
            {literal}
            function goto_step1()
            {
            $("#form1").attr("action", "?action=bud_ru_zay_create");
            $("#form1").find(":input[required]").attr('required',false);
            $("#form1").find("input[name=sku_values]").val(escapeHtml(JSON.stringify(GetSkuSelectedAll())));
            $("#form1").find("input[name=step_params]").val(escapeHtml(JSON.stringify(GetStepParams())));
            $("#form1").submit();
            }
            function escapeHtml(text) {
                var map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };

                return text.replace(/[&<>"']/g, function(m) { return map[m]; });
            }
            {/literal}
            </script>
        {/if}
        <form target="_self" method="POST" name=form1 id=form1 enctype="multipart/form-data">
        <input type=hidden name=tu value={$smarty.request.tu}>
            {if not $smarty.request.admin}
                    <h3>Рекомендуемый порядок согласования:</h3>
                    <p style="color:red">
                                            {foreach key=key item=item from=$bud_ru_st_ras}
                                                    {if $item.id eq $smarty.request.new.st}
                                                            {$item.hint|nl2br}
                                                    {/if}
                                            {/foreach}
                    </p>
                    <h3>Согласователи. (Последний согласователь будет назначен адресатом заявки на проведение активности)</h3>
                    <div style="color:red" id=cat_hint></div>
                    <p><a id="add_file1" href="javascript:void(0);" onclick="javascript:add_acceptor();">Добавить согласователя</a></p>
                    <input id="acc" type=hidden required>
                    <input type=hidden id="ac1"/>
                    <script>{foreach from=$bud_ru_zay_edit_acceptors key=k item=i name=acc}add_acceptor({$i.tn});{/foreach}</script>
                    <p><a id="add_exec" href="javascript:void(0);" onclick="javascript:add_executor();">Добавить исполнителя</a></p>
                    <input type=hidden id="exe1"/>
                    <script>{foreach from=$bud_ru_zay_edit_executors key=k item=i name=acc}add_executor({$i.tn});{/foreach}</script>
            {/if}
        <h3>Обязательные приложения:</h3>
        <p style="color:green">
                                {foreach key=key item=item from=$bud_ru_st_ras}
                                        {if $item.id eq $smarty.request.new.kat}
                                                {$item.req_att|nl2br}
                                        {/if}
                                {/foreach}
        </p>



        {if not $smarty.request.admin}
        <p><input type='submit' id='save' name='save' value="Отправить заявку на согласование"></p>
        {else}
        <p><input type='submit' id='save' name='save' value="Сохранить заявку"></p>
        {/if}


        <h3>Общие вводные</h3>
        <input type=hidden name="new[tn]" value="{$smarty.request.new.tn}">
        <table border="1">
                <tr>
                        <td>Статья расходов</td>
                        <td>
                                {foreach key=key item=item from=$bud_ru_st_ras}
                                        {if $item.id eq $smarty.request.new.st}
                                                {$item.name|escape}
                                                <input type=hidden name=new[st] value="{$smarty.request.new.st}">
                                        {/if}
                                {/foreach}
                        </td>
                </tr>
                <tr>
                        <td>Категория статьи расходов</td>
                        <td>
                                {foreach key=key item=item from=$bud_ru_st_ras}
                                        {if $item.id eq $smarty.request.new.kat}
                                                {$item.name|escape}
                                                <input type=hidden name=new[kat] value="{$smarty.request.new.kat}">
                                        {/if}
                                {/foreach}
                        </td>
                </tr>
                <tr>
                        <td>Дата создания {if $smarty.request.tu eq 1}ТУ{else}заявки{/if}</td>
                        <td>{$now}</td>
                </tr>
                <tr>
                        <td>Дата начала {if $smarty.request.tu eq 1}действия ТУ{else}проведения активности{/if}</td>
                        <td>
                            {if !$smarty.request.for_kk and $smarty.request.new.id_net}
                            <input id="master" class="datepicker" size=10 name=new[dt_start] value="{$smarty.request.new.dt_start}"
                                   onchange="load_fils({$smarty.request.new.fil});">
                            {else}
                            <input id="master" class="" size=10 name=new[dt_start] value="{$smarty.request.new.dt_start}" readonly="readonly">
                            {/if}
                            <!--<input id="master" class="datepicker" size=10 name=new[dt_start] value="{$smarty.request.new.dt_start}"
                                   onchange="load_fils({$smarty.request.new.fil});">-->
                        </td>
                </tr>
                <tr>
                        <td>Дата окончания {if $smarty.request.tu eq 1}действия ТУ{else}проведения активности{/if}</td>
                        <td>
                            {if !$smarty.request.for_kk and $smarty.request.new.id_net}
                            <input id="slave" class="datepicker" size=10 name=new[dt_end] value="{$smarty.request.new.dt_end}">
                            {else}
                            <input id="slave" class="" size=10 name=new[dt_end] value="{$smarty.request.new.dt_end}" readonly="readonly">
                            {/if}
                            <!--<input id="slave" class="datepicker" size=10 name=new[dt_end] value="{$smarty.request.new.dt_end}">-->
                        </td>
                </tr>

            {if not $smarty.request.admin}
            <script>
            {$DisabledDates}
            {literal}
            $(
                    function()
                    {
                            //$('#master').datepicker('option', 'minDate', -154);
                            //$('#master').datepicker('option', 'minDate', '01.01.2015');
                            $('#master').datepicker('option', 'minDate', '{/literal}{$now1}{literal}');
                            //$('#master').datepicker('option', 'minDate', -5);
                            {/literal}
                            {if $smarty.request.tu eq 1}
                                    $('#master').change();
                            {else}
                                    $('#slave').datepicker('option', 'minDate', $('#master').datepicker('getDate'))
                            {/if}
                            {literal}
                    }
            )
            $('#master').change(
                    function()
                    {
                            $('#slave').datepicker('option', 'minDate', $('#master').datepicker('getDate'))
                            {/literal}
                            {if $smarty.request.tu eq 1}
                                    var dts = $('#master').val().split(".");
                                    var dtd = new Date(
                                                    parseInt(dts[2], 10),
                                                    parseInt(dts[1], 10) - 1,
                                                    parseInt(dts[0], 10));
                                    dtd.setDate(dtd.getDate() + 365); 
                                    var formatted = $.datepicker.formatDate("dd.mm.yy", dtd);
                                    $('#slave').datepicker('option', 'minDate', formatted);
                            {else}
                                    $('#slave').val($('#master').val());
                            {/if}
                                {if $smarty.request.new.st eq 169138069}
                                    loadProductList($('#master').val(),$('#slave').val());
                                {/if}
                            {literal}
                    }
            );
            $('#slave').change(
                    function()
                    {
                            {/literal}
                                {if $smarty.request.new.st eq 169138069}
                                    loadProductList($('#master').val(),$('#slave').val());
                                {/if}
                            {literal}
                    }
            );
            {/literal}
            </script>
            {/if}
                <tr>
                        <td>Инициатор</td>
                        <td>{$me.fio}</td>
                </tr>
                <tr>
                        <td>Регион / Подразделение</td>
                        <td>{$me.region_name} / {$me.department_name}</td>
                </tr>
                <tr>
                        <td>Дистрибутор(ы)</td>
                        <td>
                            {if !$smarty.request.for_kk and $smarty.request.new.id_net}
                            <select name=new[fil] id=new_fil required></select>
                            <script>
                                $('#new_fil option[value="{$smarty.request.new.fil}"]').prop('selected', true);
                            </script>
                            {else}
                            <input type=hidden name=new[fil] value="{$smarty.request.new.fil}">
                            <span class="fil_name"></span>
                            <script>
                                $('.fil_name').load('?action=bud_ru_zay_create_fils&nohead=1&dt='+$('#master').val(),function(Response, st,xh) {
                                    var fil_id = {$smarty.request.new.fil};
                                    var fil_name = $(Response).map(function() {
                                        if(fil_id == $( this ).val())
                                            return $( this ).text();
                                    }).get();
                                    $(this).text(fil_name);
                                });
                            </script>
                            {/if}
                            <!--{$fil_name}-->
                            <!--<select name=new[fil] id=new_fil required></select>-->
                            <script>
                                // $('#new_fil option[value="{$smarty.request.new.fil}"]').prop('selected', true);
                            </script>
                        </td>
                        <!--<input type=hidden name=new[fil] value="{$smarty.request.new.fil}">-->
                </tr>
                <script>
                /*{literal}*/
                function load_fils(fil)
                {
                        $('#new_fil').load('?action=bud_ru_zay_create_fils&nohead=1&dt='+$('#master').val(),function() {
                                init_form();
                                $('#new_fil option[value="'+fil+'"]').prop('selected', true);
                        });
                }
                /*{/literal}*/
                $(
                        function()
                        /*{literal}*/{/*{/literal}*/
                            load_fils({$smarty.request.new.fil});
                        /*{literal}*/}/*{/literal}*/
                )
                </script>
                <tr>
                        <td>ФИО РМ/НМКК</td>
                        <td>{$rm.fio}</td>
                </tr>
                <tr>
                        <td>Мобильный телефон</td>
                        <td>{$me.phone}</td>
                </tr>
                <tr>
                        <td>Электронный корпоративный адрес</td>
                        <td>{$me.e_mail}</td>
                </tr>
                <tr>
                        <td>Скайп</td>
                        <td>{$me.skype}</td>
                </tr>
                {if not $smarty.request.tu eq 1}
                <tr>
                        <td>Фонд</td>
                        <td>
                            {if !$smarty.request.for_kk and $smarty.request.new.id_net}
                            <select name=new[funds] id=funds
                            required
                            >
                            <option></option>
                            {foreach key=key item=item from=$funds}
                            <option value="{$item.id}">{$item.name|escape}</option>
                            {/foreach}
                            </select>
                            <script>
                                $('#funds option[value={$smarty.request.new.funds}]').prop('selected', true);
                            </script>
                            {else}
                            <input type=hidden name=new[funds] value="{$smarty.request.new.funds}">
                            {foreach key=key item=item from=$funds}
                            {if $item.id eq $smarty.request.new.funds}
                            <span class="funds_name">{$item.name|escape}</span>
                            {/if}
                            {/foreach}
                            {/if}
                                <!--<select name=new[funds] id=funds-->
                                        <!--required-->
                                <!--&gt;-->
                                <!--<option></option>-->
                                <!--{foreach key=key item=item from=$funds}-->
                                        <!--<option value="{$item.id}">{$item.name|escape}</option>-->
                                <!--{/foreach}-->
                                <!--</select>-->
                        </td>
                        <script>
                            // $('#funds option[value={$smarty.request.new.funds}]').prop('selected', true);
                        </script>
                </tr>
                {/if}
                {if $smarty.request.for_kk or $smarty.request.new.id_net}
                <tr>
                        <td>Возмещение дистрибутору</td>
                        <td>
                                <input
                                        type=checkbox
                                        id=distr_compensation_cb
                                        {if not $smarty.request.new.distr_compensation}disabled{/if}
                                        {if $smarty.request.new.distr_compensation}checked{/if}
                                        onchange="$('#distr_compensation').val(this.checked?1:0);"
                                >
                                <input
                                        type=hidden
                                        name=new[distr_compensation]
                                        id=distr_compensation
                                        {if not $smarty.request.new.distr_compensation}disabled{/if}
                                        {if $smarty.request.new.distr_compensation}value=1{/if}
                                >
                        </td>
                </tr>
                <tr>
                        <td>Сеть</td>
                        <td>
                            {if !$smarty.request.for_kk and $smarty.request.new.id_net}
                            <select name=new[id_net] id=net
                            required
                            >
                            <option></option>
                            {foreach key=key item=item from=$nets}
                            <option value="{$item.id_net}">{$item.net_name|escape}</option>
                            {/foreach}
                            </select>
                            <script>
                                $('#net option[value={$smarty.request.new.id_net}]').prop('selected', true);
                            </script>
                            {else}
                            <input type=hidden name=new[id_net] id=net value="{$smarty.request.new.id_net}">
                            {foreach key=key item=item from=$nets}
                            {if $item.id_net eq $smarty.request.new.id_net}
                            <span class="net_name">{$item.net_name|escape}</span>
                            {/if}
                            {/foreach}
                            {/if}
                                <!--<select name=new[id_net] id=net-->
                                        <!--required-->
                                <!--&gt;-->
                                <!--<option></option>-->
                                <!--{foreach key=key item=item from=$nets}-->
                                        <!--<option value="{$item.id_net}">{$item.net_name|escape}</option>-->
                                <!--{/foreach}-->
                                <!--</select>-->
                        </td>
                        <script>
                            // $('#net option[value={$smarty.request.new.id_net}]').prop('selected', true);
                        </script>
                </tr>
                <tr>
                        <td>Форма оплаты</td>
                        <td>
                            {if !$smarty.request.for_kk and $smarty.request.new.id_net}
                            <select name=new[payment_type] id=payment_type
                            required
                            >
                            <option value=0></option>
                            {foreach key=key item=item from=$payment_type}
                            <option value={$item.id}>{$item.pay_type}</option>
                            {/foreach}
                            </select>
                            <script>
                                $('#payment_type option[value={$smarty.request.new.payment_type}]').prop('selected', true);
                            </script>
                            {else}
                            <input type=hidden name=new[payment_type] id=payment_type value="{$smarty.request.new.payment_type}">
                            {foreach key=key item=item from=$payment_type}
                            {if $item.id eq $smarty.request.new.payment_type}
                            <span class="payment_name">{$item.pay_type}</span>
                            {/if}
                            {/foreach}
                            {/if}
                                <!--<select name=new[payment_type] id=payment_type-->
                                        <!--required-->
                                <!--&gt;-->
                                        <!--<option value=0></option>-->
                                        <!--{foreach key=key item=item from=$payment_type}-->
                                        <!--<option value={$item.id}>{$item.pay_type}</option>-->
                                        <!--{/foreach}-->
                                <!--</select>-->
                        </td>
                        <script>
                            // $('#payment_type option[value={$smarty.request.new.payment_type}]').prop('selected', true);
                        </script>
                </tr>
                <tr>
                        <td>Статья затрат</td>
                        <td>
                            {if !$smarty.request.for_kk and $smarty.request.new.id_net}
                            <select name=new[statya] id=statya
                            required
                            >
                            <option value=0></option>
                            {foreach key=key item=item from=$statya_list}
                            <option {if $item.parent eq 0}disabled{/if} value={$item.id}>{if $item.parent neq 0}&nbsp&nbsp&nbsp{/if}{$item.cost_item}</option>
                            {/foreach}
                            </select>
                            <script>
                                 $('#statya option[value={$smarty.request.new.statya}]').prop('selected', true);
                            </script>
                            {else}
                            <input type=hidden name=new[statya] id=statya value="{$smarty.request.new.statya}">
                            {foreach key=key item=item from=$statya_list}
                            {if $item.id eq $smarty.request.new.statya}
                            <span class="payment_name">{$item.cost_item}</span>
                            {/if}
                            {/foreach}
                            {/if}
                                <!--<select name=new[statya] id=statya-->
                                        <!--required-->
                                <!--&gt;-->
                                        <!--<option value=0></option>-->
                                        <!--{foreach key=key item=item from=$statya_list}-->
                                        <!--<option {if $item.parent eq 0}disabled{/if} value={$item.id}>{if $item.parent neq 0}&nbsp&nbsp&nbsp{/if}{$item.cost_item}</option>-->
                                        <!--{/foreach}-->
                                <!--</select>-->
                        </td>
                        <script>
                            // $('#statya option[value={$smarty.request.new.statya}]').prop('selected', true);
                        </script>
                </tr>
                {/if}
        </table>

        <h3>Расчет по заявке и приложения</h3>

        <table border="0">
                <tr style="font-weight:bold">
                        <td>Показатель</td>
                        <td>Значение</td>
                </tr>
                {foreach key=k item=i from=$st name=st_fields}
                        {if $smarty.foreach.st_fields.iteration eq 5 and ($smarty.request.for_kk or $smarty.request.new.id_net)}
                        <tr class="hide-dev1">
                            <td>Бонус дистрибьютора, %:</td>
                            <td><input type="text" name="bonus_distr_pers" id="bonus_distr_pers" size="10" value="" disabled="disabled"></td>
                        </tr>
                {/if}
                {if $smarty.foreach.st_fields.iteration eq 6 and ($smarty.request.for_kk or $smarty.request.new.id_net)}
                        <tr style="">
                            <td>
                                Продукты:
                            </td>
                            <td style="max-width: 475px;">
                                <input type="hidden" name="akciya_type" id="akciya_type" value="{$smarty.request.akciya_type}">
                                <input type="hidden" name="bonus_net_perc" id="bonus_net_perc" value="{$smarty.request.bonus_net_perc}">
                                <input type="hidden" name="akciya_expences_perc" id="akciya_expences_perc" value="{$smarty.request.akciya_expences_perc}">
                                <input type="hidden" name="sku_values" value='{if $smarty.request.sku_values}{$smarty.request.sku_values}{/if}'>
                                <input type="hidden" name="step_params" value='{if $smarty.request.step_params}{$smarty.request.step_params}{/if}'>
                                <style>
                                    .select2-container .select2-search--inline, .select2-container .select2-search--inline input {
                                        width: 100%!important;
                                    }
                                    ul.select2-results__options .sku_item_option {
                                        border: 1px solid #eee;
                                        padding: 5px;
                                        border-radius: 3px;
                                        background-color: #f3f3f3;
                                    }
                                    .select2-container--default .select2-results__option--highlighted[aria-selected]{
                                        background-color: transparent;
                                    }
                                    .select2-container--default .select2-results__option--highlighted[aria-selected] .sku_item_option{
                                        background-color: #FFC107;
                                    }
                                    ul.select2-results__options .select2-results__option--highlighted .sku_item_option {
                                        color: #183e86;
                                    }
                                    .select2-container--default .select2-results__option[aria-selected=true]{
                                        background-color:transparent;
                                    }
                                    .select2-container--default .select2-results__option[aria-selected=true] .sku_item_option
                                    {
                                        background-color: #8BC34A;
                                    }
                                    .no-padding{
                                        padding: 0!important;
                                    }
                                    .sku_item_option tbody tr td:first-child {
                                        font-size: 10px;
                                    }
                                    .hide-dev{
                                        display:none;
                                        border: 2px dashed red;
                                        background-color: #ffe9e9;
                                    }
                                    .del_sku_current {
                                        font-size: 11px;
                                        cursor: pointer;
                                        border-radius: 3px;
                                        border-width: 2px;
                                        border-style: outset;
                                        transition: all 0.2s;
                                    }
                                    .del_sku_current:hover {
                                        background-color: #f4433670;
                                        border-style: inset;
                                    }
                                    #sku_selected input[readonly="readonly"] {

                                        background-color: #eee;
                                        border: none;
                                        border: 1px solid #ae9797e6;
                                        border-top-style: solid;
                                        border-right-style: solid;
                                        border-bottom-style: solid;
                                        border-left-style: solid;
                                        border-style: inset;

                                    }
                                </style>
                                <select id="sku_select" name="sku_select[]" style="width:100%;"></select>
                            </td>
                        </tr>
                        <tr class="hide-dev1">
                            <td colspan="2">

                                <table id="sku_selected" width="100%" border="1" style="max-width: 900px;background-color: #fff;display: none;">
                                    <thead style="background-color: #03a9f454;">
                                    <tr style="font-size: 10px;font-weight: bold;text-align: center;">
                                        <td rowspan="2"></td>
                                        <td rowspan="2">TAG_ID</td>
                                        <td rowspan="2">Бренд</td>
                                        <td rowspan="2">Продукт</td>
                                        <td rowspan="2">Вес, кг</td>
                                        <td rowspan="2">СС,грн/кг</td>
                                        <td rowspan="2">Цена своб.-отпускн. Укр.,грн с НДС</td>
                                        <td rowspan="2">Цена Спец-ии КК, грн с НДС</td>
                                        <td rowspan="2">Цена за продажи в сеть за ед.,грн с НДС</td>
                                        <td rowspan="2" class="type2">Цена за продажи в сеть за ед. со скидкой,грн с НДС</td>
                                        <td rowspan="2">Объем продажи,шт.</td>
                                        <!--
                                        <td rowspan="2">Объем продажи,кг.</td>
                                        <td rowspan="2">Объем продаж, грн с НДС</td>
                                        <td rowspan="2" class="type2">Объем продаж с учетом скидки, грн с НДС</td>
                                        <td rowspan="2">СС на объем отгрузки,грн с НДС</td>
                                        <td rowspan="2">Ожидаемая ВП,грн с НДС</td>
                                        <td colspan="5" class="colspan5">Расходы сети итого, вт.ч.</td>
                                        <td rowspan="2">Чистая прибыль, грн с НДС</td>
                                        <td rowspan="2" class="type2">Расходы по акции в скидке, грн с НДС</td>
                                        <td rowspan="2" class="type2">Всего затрат по сети, грн с НДС</td>
                                        -->
                                    </tr>
                                    <!--
                                    <tr style="font-size: 10px;font-weight: bold;text-align: center;">
                                        <td>Бонус сети, грн с НДС</td>
                                        <td class="type1">Затраты по акции б/н (компенсация), грн с НДС</td>
                                        <td>Бонус дистриб, грн с НДС</td>
                                        <td>Расходы по логистике</td>
                                        <td>Расходы Компании, грн с НДС</td>
                                    </tr>
                                    -->
                                    </thead>
                                    <tbody>
                                    <!-- SKU -->
                                    </tbody>
                                </table>
                            </td>
                        </tr>
                        {/if}
            {if (!$smarty.request.for_kk and !$smarty.request.new.id_net)}
                {if $i.id eq 176933669 or $i.id eq 177005005 or $i.id eq 176856141}
                    {continue}
                {/if}
            {/if}
                        <tr style="background-color:#{$i.color};font-weight:{if $i.bold eq 1}bold{/if};">
                                <td>
                                        {$i.name}
                                </td>
                                <td>
                                        {if $i.type eq 'textarea'}
                                                <textarea rows=5 cols=50 id=new_st_{$i.id} name=new_st[{$i.id}] {if $i.required}required{/if}></textarea>
                                        {else}
                                                {if $i.type eq 'file'}
                                                        <input id=new_st_{$i.id} name=new_st[{$i.id}][] type=file multiple {if not $smarty.request.id and $i.required}required{/if}>
                                                        {foreach key=k1 item=i1 from=$smarty.request.edit_st}
                                                                {if $i1.type eq 'file' and $i1.ff_id eq $i.id}
                                                                        {foreach key=k2 item=i2 from=$i1.val_file}
                                                                                <br><input type=checkbox name="bud_ru_zay_files_del[{$i1.ff_id}][{$i2}]" value="files/bud_ru_zay_files/{$smarty.request.id}/{$i1.ff_id}/{$i2}"><nobr><a target=_blank href="files/bud_ru_zay_files/{$smarty.request.id}/{$i1.ff_id}/{$i2}">{$i2}</a></nobr>
                                                                        {/foreach}
                                                                {/if}
                                                        {/foreach}
                                                {else}
                                                        {if $i.type eq 'list'}
                                                                {if $i.autocomplete eq 1}
                                                                    <input size=70 id=new_st_select_{$i.id}>
                                                                        <input type="hidden" id=new_st_{$i.id} name=new_st[{$i.id}] {if $i.required}required{/if}>
                                                                        <script>
                                                                        {literal}
                                                                        $(function() {
                                                                        $( "#new_st_select_{/literal}{$i.id}{literal}" ).autocomplete({
                                                                                minLength: 0,
                                                                                source: "?action=bud_ru_zay_autocomplete&nohead=1&ff_id={/literal}{$i.id}{literal}&tn={/literal}{$me.tn}{literal}",
                                                                                focus: function( event, ui ) {
                                                                                        $( "#new_st_select_{/literal}{$i.id}{literal}" ).val( ui.item.label );
                                                                                                return false;
                                                                                        },
                                                                                select: function( event, ui ) {
                                                                                        $( "#new_st_select_{/literal}{$i.id}{literal}" ).val( ui.item.label );
                                                                                        $( "#new_st_{/literal}{$i.id}{literal}" ).val( ui.item.value );
                                                                                        return false;
                                                                                }
                                                                        }).data( "ui-autocomplete" )._renderItem = function( ul, item ) {
                                                                                return $("<div style=\"width:600px\">" + item.label + "</div>").appendTo( ul );
                                                                        };
                                                                        });
                                                                        {/literal}
                                                                        </script>
                                                                {else}
                                                                        {if $i.id eq 176856141}
                                                                            <select id=new_st_{$i.id} class="akc_type_base" name=new_st[{$i.id}] {if $i.required}required{/if}>
                                                                            {foreach key=lk item=li from=$i.list name=list_akc}
                                                                            <option
                                                                                    value={$li.id}
                                                                                    {if $smarty.foreach.list_akc.iteration eq 1}selected="selected"{/if}
                                                                                    data-type={$smarty.foreach.list_akc.iteration}
                                                                            >{$li.name}</option>
                                                                            {/foreach}
                                                                            </select>
                                                                        {else}
                                                                            <select id=new_st_{$i.id} name=new_st[{$i.id}] {if $i.required}required{/if}>
                                                                            <option></option>
                                                                            {foreach key=lk item=li from=$i.list}
                                                                                    <option value={$li.id}>{$li.name}</option>
                                                                            {/foreach}
                                                                            </select>
                                                                        {/if}
                                                                {/if}
                                                        {else}
                                                                {if $i.type eq 'bool'}
                                                                        <input
                                                                                type=checkbox
                                                                                id=new_st_{$i.id}
                                                                                {if $i.required}required{/if}
                                                                                onChange="$('#new_st_{$i.id}_val').val(this.checked?1:0);"
                                                                        >
                                                                        <input
                                                                                type=hidden
                                                                                id=new_st_{$i.id}_val
                                                                                name=new_st[{$i.id}]
                                                                                value=0
                                                                        >
                                                                {else}
                                        {if $i.type eq 'formula'}
                                                                                <input type=hidden name=new_st[{$i.id}] value=0>
                                                                                <!--
                                                                                {$i.formula}
                                                                                <input name=new_st[{$i.id}] id=new_st_{$i.id} class="number5">
                                                                                -->
                                                                                <input disabled id=new_st_{$i.id} class="number5">
                                                                                {else}
                                                                                <!--
                                                                                {$i.var_name}
                                                                                {$i.rep_var_name}
                                                                                -->
                                                                            {if $i.id eq 176933669 or $i.id eq 177005005}

                                                                                <input
                                                                                    type="text"
                                                                                    size=10
                                                                                    id=new_st_{$i.id}
                                                                                    name=new_st[{$i.id}]
                                                                                    class="{if $i.id eq 177005005}bonus_net_perc{else}akciya_expences_perc{/if}"
                                                                                    {if $i.required}required{/if}

                                                                                    >
                                                                            {else}
                                                                                <input
                                                                                    size={if $i.type eq 'datepicker'}10{else}70{/if}
                                                                                    id=new_st_{$i.id}
                                                                                    name=new_st[{$i.id}]
                                                                                    class="{$i.class}"
                                                                                    {if $i.required}required{/if}
                                                                                    onKeyUp="calc_formula();"
                                                                                    >
                                                                            {/if}
                                                                        {/if}
                                                                {/if}
                                                        {/if}
                                                {/if}
                                        {/if}
                                </td>
                        </tr>
                {/foreach}
                <script>
                {foreach key=k1 item=i1 from=$smarty.request.edit_st}
                        {if $i1.val_list}
                                {if $i1.autocomplete eq 1}
                                        $('#new_st_select_{$i1.ff_id}').val(
                                                '{$i1.val_list_name|escape:"quotes"|regex_replace:"/[\r\t\n]/":" "}'
                                                );
                                        $('#new_st_{$i1.ff_id}').val({$i1.val_list});
                                {else}
                                        $('#new_st_{$i1.ff_id} option[value={$i1.val_list|escape}]').prop('selected', true);
                                {/if}
                        {elseif $i1.val_bool}
                                $("#new_st_{$i1.ff_id}").attr('checked','{$i1.val_bool}'=='1'?true:false);
                                $("#new_st_{$i1.ff_id}_val").val(1);
                        {else}
                                $("#new_st_{$i1.ff_id}").val('{$i1.val_string|escape:"quotes"}{$i1.val_textarea|escape:"quotes"|regex_replace:"/[\r\t\n]/":" "}{$i1.val_number_int}{$i1.val_number}{$i1.val_datepicker}{$i1.val_formula}');
                                $("input[name='new_st[{$i1.ff_id}]']").val('{$i1.val_string|escape:"quotes"}{$i1.val_textarea|escape:"quotes"|regex_replace:"/[\r\t\n]/":" "}{$i1.val_number_int}{$i1.val_number}{$i1.val_datepicker}{$i1.val_formula}');
                        {/if}
                {/foreach}
                </script>
        </table>
            {if $smarty.request.new.st eq 169138069}
                <h3>Таблица расчета</h3>
                <p>
                <select id="productList"></select>
                <input id="buttonAddProduct" type="button" value="добавить продукт" onClick="addProduct($('#master').val(),$('#slave').val(),$('#productList').val())">
                </p>
                <table border="1" width="800px">
                    <tr style="font-weight: bold; text-align: center">
                        <td></td>
                        <td>1</td>
                        <td>2</td>
                        <td>3</td>
                        <td>4</td>
                        <td>5</td>
                        <td>6</td>
                        <td>7</td>
                        <td>8</td>
                        <td>9</td>
                        <td>10</td>
                        <td>11</td>
                        <td>12</td>
                        <td>13</td>
                        <td>14</td>
                        <td>15</td>
                        <td>16</td>
                        <td>17</td>
                    </tr>
                    <tr style="font-weight: bold; text-align: center">
                        <td></td>
                        <td>Бренды</td>
                        <td>Продукт</td>
                        <td>Продукт. Вес</td>
                        <td>Компенсация, %</td>
                        <td>Цена Спец-ии КК ед</td>
                        <td>Цена Продажи в сеть, ед</td>
                        <td>Цена Продажи ед без НДС</td>
                        <td>План продаж, кг</td>
                        <td>План продаж, ед</td>
                        <td>План отгрузки, грн</td>
                        <td>Затраты по скидке, грн</td>
                        <td>Авторизация, др затраты</td>
                        <td>Наценка/скидка к протоколу АВК, %</td>
                        <td>Протокол АВК</td>
                        <td>sku_id</td>
                        <td>tagid</td>
                        <td>product_id</td>
                    </tr>
                    <tr style="font-weight: bold; text-align: center" id="tableProducts">
                        <td>итого</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td><input type="hidden" id="ftotal8"><div id="ltotal8"></div></td>
                        <td><input type="hidden" id="ftotal9"><div id="ltotal9"></div></td>
                        <td><input type="hidden" id="ftotal10"><div id="ltotal10"></div></td>
                        <td><input type="hidden" id="ftotal11"><div id="ltotal11"></div></td>
                        <td><input type="hidden" id="ftotal12"><div id="ltotal12"></div></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </table>
                {literal}
                <script>
                    function changeRow(id){
                        $('#f7_'+id).val(myRound($('#f6_'+id).val()/1.2,2));
                        $('#f8_'+id).val(myRound($('#f3_'+id).val()*$('#f9_'+id).val(),2));
                        $('#f10_'+id).val(myRound($('#f6_'+id).val()*$('#f9_'+id).val(),2));
                        $('#f11_'+id).val(myRound($('#f4_'+id).val()*$('#f10_'+id).val()/100,2));
                        $('#f13_'+id).val(myRound(($('#f6_'+id).val()/$('#f14_'+id).val()-1)*100,2));
                        var ids = [7,8,10,11,13]
                        for (i = 0; i < ids.length; i++) {
                            $('#l'+ids[i]+'_'+id).text($('#f'+ids[i]+'_'+id).val());
                        }
                        var totals = [8,9,10,11,12]
                        for (i = 0; i < totals.length; i++) {
                            $('#ftotal'+totals[i]).val(0.0);
                            $('.f'+totals[i]).each(function(){$('#ftotal'+totals[i]).val(
                                        myRound(Number($('#ftotal'+totals[i]).val())+Number($(this).val()),2)
                                        );});
                            $('#ltotal'+totals[i]).text($('#ftotal'+totals[i]).val());
                        }
                        $('#new_st_169138086').val($('#ftotal11').val()/1000);
                        $('#new_st_169138087').val((Number(($('#ftotal11').val()))+Number($('#ftotal12').val()))/1000);
                        $('#new_st_169138088').val($('#ftotal10').val()/1000);
                        calc_formula();
                    }
                    function loadProductList(master,slave)
                    {
                        $('#productList').load('?action=bud_ru_zay_create_2&print=1&nohead=1&getProductList=1',{sd:master,ed:slave},function() {});
                    }
                    function addProduct(master,slave,product)
                    {
                    if (
                            product==null
                            ||product==''
                            ||($("#productList option[value='"+ product + "']").attr('disabled')==true) 
                    ){return;}
                    $('#buttonAddProduct').prop("disabled",true);
                    var fd = new FormData();
                    fd.append('sd',  master);
                    fd.append('ed',  slave);
                    fd.append('product',  product);
                    $.ajax({
                        type: 'POST',
                        url: '?action=bud_ru_zay_create_2&getProduct=1&print=1&nohead=1',
                        data: fd,
                        processData: false,
                        contentType: false,
                        success: function(data) {
                            $(''+data+'').insertBefore($('#tableProducts'));
                            $('#buttonAddProduct').prop("disabled",false);
                            $("#productList option[value='"+ product + "']").attr('disabled', true); 
                        }
                    });
                    }
                    loadProductList($('#master').val(),$('#slave').val());
                </script>
                {/literal}
            {/if}
        </form>
    {/if}
    <script>
    var zid = {$smarty.request.id|default:0};
    function calc_formula ()
    {literal}{{/literal}
            {foreach key=k item=i from=$st}
                    {if ($i.type eq 'number' or $i.type eq 'number_int') and $i.var_name}
                            var {$i.var_name}=parseFloat($('#new_st_{$i.id}').val());
                    {/if}
            {/foreach}
            {foreach key=k item=i from=$st}
                    {if $i.type eq 'formula'}
                            var fid = {$i.id};
                            var f='{$i.formula}';
                            f=f.split("$").join("");
                            //console.log(f);
                            //console.log(zid);
                            var r=eval(f);
                            //console.log(r);
                            if (r!=undefined)
                            {literal}{{/literal}
                                    r!=r?r=null:r=r.toFixed(3);
                                    $('#new_st_{$i.id}').val(r);
                                    $("input[name='new_st[{$i.id}]']").val(r);
                            {literal}}{/literal}
                    {/if}
            {/foreach}
    {literal}}{/literal}
    {foreach key=k item=i from=$linked_fields}
            $('#new_st_{$k}').click(
                    function()
                    {literal}{{/literal}
                            {foreach key=k1 item=i1 from=$i}
                                    $('#new_st_select_{$i1.id}').attr('disabled',true);
                                    $('#new_st_{$i1.id}').attr('disabled',true);
                            {/foreach}
                            {foreach key=k1 item=i1 from=$i}
                                    if ($('#new_st_{$k}').val()=={$i1.parent_field_val})
                                    {literal}{{/literal}
                                            $('#new_st_select_{$i1.id}').attr('disabled',false);
                                            $('#new_st_{$i1.id}').attr('disabled',false);
                                    {literal}}{/literal}
                            {/foreach}
                    {literal}}{/literal}
            );
            $('#new_st_{$k}').click();
    {/foreach}

    </script>
    <script src="js/sku_avk.js?{filemtime( 'js/sku_avk.js' )}" type="text/javascript"></script>
{/if}
