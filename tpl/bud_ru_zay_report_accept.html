<h3>{if $smarty.request.tu eq 1}Результаты переговоров{else}Отчеты по активности{/if}, согласование</h3>

{$tooManyLines}

<form target="_self" method="POST" name=form_bud_ru_zay_report_accept id=form_bud_ru_zay_report_accept enctype="multipart/form-data">

<input type=hidden name=tu value={$smarty.request.tu}>

<p>
<input checked="checked" name="wait4myaccept" id="wait4myaccept" value="0" type="radio"> ожидают моего согласования
<input name="wait4myaccept" id="wait4myaccept" value="1" type="radio"> все
<script>$("input[name=wait4myaccept][value={$smarty.request.wait4myaccept}]").attr('checked',true);</script>
</p>

<table>
	{if $smarty.request.tu neq 1}
	<tr>
		<td style="text-align:right">Статья расходов</td>
		<td>
			<select name=st id=st>
				<option value=0></option>
				{foreach key=key item=item from=$st}
				{if $item.parent eq 0}<option value={$item.id}>{$item.name}</option>{/if}
				{/foreach}
			</select>
			<script>$('#st option[value="{$smarty.request.st}"]').prop('selected', true);</script>
		</td>
	</tr>
	{/if}
</table>

<p>
<input type="submit" name="refresh" id="refresh" value="Обновить страницу">
<input type="submit" name="save" id="save" value="Сохранить">
</p>

<table border=1 cellpadding=5 cellspacing=0>
	<tr style="text-align:center;font-weight:bold">
		<td rowspan=2>{if $smarty.request.tu eq 1}Общая информация{else}Заголовок заявки{/if}</td>
		<td rowspan=2>{if $smarty.request.tu eq 1}Цели на переговоры{else}Поля заявки{/if}</td>
		<td rowspan=2>{if $smarty.request.tu eq 1}Результаты переговоров{else}Отчет по заявке{/if}</td>
		<td colspan=3>Блок согласования</td>
	</tr>
	<tr style="text-align:center;font-weight:bold">
		<td>
				Должность, подразделение, <font style="color:red">согласователь</font>
				<font style="color:green">статус</font>
				<font style="color:blue">дата</font>
		</td>
		<td>Причина отказа</td>
		<td>Комментарии / Уточнения</td>
	</tr>
	{foreach key=k item=i from=$d}


	{if $i.head.current_status eq 0}{assign var=color value="#FFFF66"}{/if}
	{if $i.head.current_status eq 1}{assign var=color value="#66FF66"}{/if}
	{if $i.head.current_status eq 2}{assign var=color value="#FFCC99"}{/if}
	{if $i.head.valid_no eq 1}{assign var=color value="#66FFFF"}{/if}



	<tr style="background-color:{$color};vertical-align:top">
		<td>
			<input type="submit" name="save" id="save" value="Сохранить"><br>
			{if $smarty.request.tu eq 1}<a target=_blank href="?action=bud_ru_zay_sdu&z_id={$i.head.id}">Система договорных условий</a><br>{/if}
			<b>№:</b>{$i.head.id}<br>
{if $i.head.net_name}
<p style="border:1px dotted red">
			<b>Сеть:</b>{$i.head.net_name}<br>
			<b>Форма оплаты:</b>{$i.head.payment_type_name}<br>
			<b>Статья затрат:</b>{$i.head.statya_name}<br>
			<b>Возмещение дистрибутору:</b>{if $i.head.distr_compensation eq 1}да{else}нет{/if}<br>
</p>
{/if}
			<b>Дата создания:</b>{$i.head.created}<br>
			<b>Дата начала {if $smarty.request.tu eq 1}действия ТУ{else}проведения активности{/if}:</b>{$i.head.dt_start}<br>
			<b>Дата окончания {if $smarty.request.tu eq 1}действия ТУ{else}проведения активности{/if}:</b>{$i.head.dt_end}<br>
			<b>Регион / Подразделение:</b>{$i.head.region_name}<br>
			<b>ФИО РМ:</b>{$i.head.rm_fio}<br>
			<b>Мобильный телефон:</b>{$i.head.phone}<br>
			<b>Электронный корпоративный адрес:</b>{$i.head.e_mail}<br>
			<b>Скайп:</b>{$i.head.skype}<br>
			<b>Статья:</b>{$i.head.st_name}<br>
			<b>Категория:</b>{$i.head.kat_name}<br>
			<b>Дистрибьютор:</b>{$i.head.fil_name}<br>
			{if not $smarty.request.tu eq 1}<b>Фонд:</b>{$i.head.funds_name}<br>{/if}
			<b>Инициатор:</b>{$i.head.creator_pos_name},{$i.head.creator_department_name},<font style="color:red">{$i.head.creator}</font><br>
			<b>Адресат:</b>{$i.head.recipient_pos_name},{$i.head.recipient_department_name},<font style="color:red">{$i.head.recipient}</font><br>
			<b>Исполнители:</b><br>
			{foreach key=k1 item=i1 from=$i.executors name=ex}
				{if $i1.executor_name neq null}
				<b>{$smarty.foreach.ex.iteration}.</b> {$i1.executor_pos_name}, {$i1.executor_department_name}, <font style="color:red">{$i1.executor_name}</font><br>
				{/if}
			{/foreach}
			<b>Дата {if $smarty.request.tu eq 1}внесения результатов переговоров{else}отчета по заявке{/if}:</b><br>
			{if $i.head.report_data}
				{$i.head.report_data}<br>
				<font style="font-weight:bold;color:green">{$i.head.report_data_fio|escape} {$i.head.report_data_lu}</font><br>
				{$i.head.report_data_text|nl2br}<br>
			{/if}
			{if $i.head.report_short eq 1}<font style="font-weight:bold;color:green">{if $smarty.request.tu eq 1}Сокращенное внесение результатов переговоров{else}Сокращенный отчет{/if}</font><br>{/if}
		</td>
		<td>
			{foreach key=k1 item=i1 from=$i.ff name=ff_array}
				{if $i.head.net_name and $i1.type eq 'list' and $i1.ff_id eq 176856141}
					{if $i1.val_list eq 176856076}
						{assign var="akc_type" value=1}
					{else}
						{assign var="akc_type" value=2}
					{/if}
				{/if}
				{if $i.head.net_name and $i1.type eq 'number' and $i1.ff_id eq 177005005}
					{assign var="bonus_net_perc" value=$i1.val_number}
				{/if}
				{if $i.head.net_name and $i1.type eq 'number' and $i1.ff_id eq 176933669}
					{assign var="akciya_expences_perc" value=$i1.val_number}
				{/if}
				{if $smarty.foreach.ff_array.iteration eq 6 and $i.head.net_name}
				<div style="">
					<span style="background-color:#{$i1.color};font-weight:{if $i1.bold eq 1}bold{/if};">Список продуктов: </span>
					<span id="open-table-sku-{$i.head.id}" class="open-table-sku" data-sz-id="{$i.head.id}">Показать таблицу</span>
					<div id="sku_table-{$i.head.id}" class="sku_table" data-sz-id="{$i.head.id}" style="display: none;">
						<!-- content -->
						<!--($z_id,$akc_type,$bonus_net_perc = null,$net_id = null,$akciya_expences_perc = null,$fil_kod=null,$print = tru)-->
						{$skuObj->GetSkuList($i.head.id,$akc_type,$bonus_net_perc,$i.head.id_net,$akciya_expences_perc,$i.head.fil)}
						{*
						{$skuObj->GetSkuList($i.head.id,$akc_type)}
						*}
						<!-- end content -->
					</div>
				</div>
				{/if}
				<span style="background-color:#{$i1.color};font-weight:{if $i1.bold eq 1}bold{/if};">{$i1.name}:&nbsp</span>
				{if $i1.type eq 'formula'}	{$i1.val_formula}{/if}
				{if $i1.type eq 'list'}		{$i1.val_list_name}{/if}
				{if $i1.type eq 'string'}	{$i1.val_string}{/if}
				{if $i1.type eq 'textarea'}	{$i1.val_textarea|nl2br}{/if}
				{if $i1.type eq 'number_int'}	{$i1.val_number_int|num:0}{/if}
				{if $i1.type eq 'number'}	{$i1.val_number|num:5}{/if}
				{if $i1.type eq 'datepicker'}	{$i1.val_datepicker}{/if}
				{if $i1.type eq 'bool'}		{if $i1.val_bool eq 1}да{else}нет{/if}{/if}
				{if $i1.type eq 'file'}
					{foreach key=k2 item=i2 from=$i1.val_file}
						<nobr><a target=_blank href="files/bud_ru_zay_files/{$i.head.id}/{$i1.ff_id}/{$i2}">{$i2}</a></nobr>&nbsp
					{/foreach}
				{/if}
				<br>
			{/foreach}
		</td>
		<td style="text-align:center">
			<b>Срок {if $smarty.request.tu eq 1}внесения результатов переговоров{else}подачи отчета{/if}:</b>
			{if $i.head.srok_ok eq 1}
				<font style="background-color:#66FF66">не истек</font>
			{else}
				<font style="background-color:#FFCC99">истек</font>
			{/if}
			<br>
			<b>Подтверждение:</b>
			{if $i.head.current_status eq 0}<font style="background-color:#FFFF66">{if $smarty.request.tu eq 1}результаты переговоров{else}отчет{/if} на согласовании</font>{/if}
			{if $i.head.current_status eq 1}<font style="background-color:#66FF66">подтвержден</font>{/if}
			{if $i.head.current_status eq 2}<font style="background-color:#FFCC99">отклонен</font>{/if}
			<br>
			<b>{if $smarty.request.tu eq 1}Результаты переговоров внесены{else}Отчет заполнен{/if}: </b>
			{if $i.head.creator_tn eq $tn and $i.head.not_seen}
					<input
						{if $i.head.report_done}checked{/if}
						onClick="
							$('#report_done_{$i.head.id}').attr('disabled',false);
							$('#report_done_{$i.head.id}').val(this.checked?1:0);
						"
						type="checkbox"
					>
					<input
						{if $i.head.report_done}value=1{/if}
						disabled
						name="report_done[{$i.head.id}]"
						id="report_done_{$i.head.id}"
						type="hidden"
					>
			{/if}
			{if $i.head.report_done}
				<font style="background-color:#66FF66">{$i.head.report_done_lu}</font>
			{else}
				<font style="background-color:#FFCC99">нет</font>
			{/if}
			<br>
			<table style="text-align: left; width: 100%;" border="1" cellpadding="2" cellspacing="0">
				<tr style="font-weight:bold">
					<td style="vertical-align: top;">Плановый показатель<br></td>
					<td style="vertical-align: top;">Фактический показатель<br></td>
				</tr>
				{foreach key=k1 item=i1 from=$i.ff }
				{if $i1.rep_r_visible}
				<tr>
					<td>

					<span style="background-color:#{$i1.color};font-weight:{if $i1.bold eq 1}bold{/if};">{$i1.name}:&nbsp</span>
					{if $i1.type eq 'formula'}	{$i1.val_formula}{/if}
					{if $i1.type eq 'list'}		{$i1.val_list_name}{/if}
					{if $i1.type eq 'string'}	{$i1.val_string}{/if}
					{if $i1.type eq 'textarea'}	{$i1.val_textarea|nl2br}{/if}
					{if $i1.type eq 'number_int'}	{$i1.val_number_int|num:0}{/if}
					{if $i1.type eq 'number'}	{$i1.val_number|num:5}{/if}
					{if $i1.type eq 'datepicker'}	{$i1.val_datepicker}{/if}
					{if $i1.type eq 'bool'}		{if $i1.val_bool eq 1}да{else}нет{/if}{/if}
					{if $i1.type eq 'file'}
						{foreach key=k2 item=i2 from=$i1.val_file}
							<nobr><a target=_blank href="files/bud_ru_zay_files/{$i.head.id}/{$i1.ff_id}/{$i2}">{$i2}</a></nobr>&nbsp
						{/foreach}
					{/if}
						</td>
						<td>

					<span style="background-color:#{$i1.color};font-weight:{if $i1.bold eq 1}bold{/if};">{$i1.rep_name}:&nbsp</span>
					{if $i.head.creator_tn eq $tn and $i.head.not_seen}
						{if $i1.type eq 'textarea'}
							<textarea id=new_st_{$i1.id} name=new_st[{$i1.id}] {if $i1.rep_required}required{/if}>{$i1.rep_val_textarea}</textarea>
						{else}
							{if $i1.type eq 'file'}
								<input id=new_st_{$i1.id} name=new_st[{$i1.id}][] type=file multiple {if $i1.rep_required and not $i1.rep_val_file}required{/if}>
								{foreach key=k2 item=i2 from=$i1.rep_val_file}
									<br><input type=checkbox name="bud_ru_zay_files_del[{$i1.id}][{$i2}]" value="files/bud_ru_zay_files/{$i.head.id}/{$i1.ff_id}/report/{$i2}"><nobr><a target=_blank href="files/bud_ru_zay_files/{$i.head.id}/{$i1.ff_id}/report/{$i2}">{$i2}</a></nobr>
								{/foreach}
								{if $i1.rep_val_file}<br>Выбрать для удаления{/if}
							{else}
								{if $i1.type eq 'list'}
									<select id=new_st_{$i1.id} name=new_st[{$i1.id}] {if $i1.required}required{/if}>
										<option></option>
										{foreach key=lk item=li from=$i1.list}	
											<option value={$li.id}>{$li.name}</option>
										{/foreach}
									</select>
									<script>
										$('#new_st_{$i1.id} option[value={$i1.rep_val_list}]').prop('selected', true);
									</script>
								{else}
									{if $i1.type eq 'bool'}
										<input
											type=checkbox
											id=new_st_{$i1.id}_cb
											{if $i1.required}required{/if}
											onChange="$('#new_st_{$i1.id}_val').val(this.checked?1:'');"
										>
										<input
											type=hidden
											id=new_st_{$i1.id}_val
											name=new_st[{$i1.id}]
											{if $i1.required}required{/if}
										>
										<script>
											$("#new_st_{$i1.id}_cb").attr('checked','{$i1.rep_val_bool}'=='1'?true:false);
											$("#new_st_{$i1.id}_val").val({$i1.rep_val_bool});
										</script>
									{else}
										<input id=new_st_{$i1.id} name=new_st[{$i1.id}] class="{$i1.class}" {if $i1.required}required{/if}>
										<script>
											{if $i1.type eq 'string'}$('#new_st_{$i1.id}').val("{$i1.rep_val_string}");{/if}
											{if $i1.type eq 'number_int'}$('#new_st_{$i1.id}').val("{$i1.rep_val_number_int}");{/if}
											{if $i1.type eq 'number'}$('#new_st_{$i1.id}').val("{$i1.rep_val_number}");{/if}
											{if $i1.type eq 'datepicker'}$('#new_st_{$i1.id}').val("{$i1.rep_val_datepicker}");{/if}
										</script>
									{/if}
								{/if}
							{/if}
						{/if}
					{else}
						{if $i1.type eq 'textarea'}	{$i1.rep_val_textarea|nl2br}{/if}
						{if $i1.type eq 'file'}
							{foreach key=k2 item=i2 from=$i1.rep_val_file}
								<nobr><a target=_blank href="files/bud_ru_zay_files/{$i.head.id}/{$i1.ff_id}/report/{$i2}">{$i2}</a></nobr>&nbsp
							{/foreach}
						{/if}
						{if $i1.type eq 'formula'}	{$i1.rep_val_formula}{/if}
						{if $i1.type eq 'list'}		{$i1.rep_val_list_name}{/if}
						{if $i1.type eq 'string'}	{$i1.rep_val_string}{/if}
						{if $i1.type eq 'number_int'}	{$i1.rep_val_number_int|num:0}{/if}
						{if $i1.type eq 'number'}	{$i1.rep_val_number|num:5}{/if}
						{if $i1.type eq 'datepicker'}	{$i1.rep_val_datepicker}{/if}
						{if $i1.type eq 'bool'}		{if $i1.rep_val_bool eq 1}да{else}нет{/if}{/if}
					{/if}
					</td>
				</tr>
				{/if}
				{/foreach}
			</table>
			{if $i.head.creator_tn eq $tn and $i.head.not_seen}
				<b>Подтверждающие документы:&nbsp;</b> <input id="sup_doc_{$i.head.id}" name="sup_doc[{$i.head.id}][]" multiple="" type="file">
				{foreach key=k2 item=i2 from=$i.head.sup_doc}
					<br><input type=checkbox name="sup_doc_del[{$i.head.id}][{$i2}]" value="files/bud_ru_zay_files/{$i.head.id}/sup_doc/{$i2}"><nobr><a target=_blank href="files/bud_ru_zay_files/{$i.head.id}/sup_doc/{$i2}">{$i2}</a></nobr>
				{/foreach}
				{if $i.head.sup_doc}<br>Выбрать для удаления{/if}
			{else}
				{if $i.head.sup_doc}
				<b>Подтверждающие документы:&nbsp;</b>
				{foreach key=k2 item=i2 from=$i.head.sup_doc}
					<nobr><a target=_blank href="files/bud_ru_zay_files/{$i.head.id}/sup_doc/{$i2}">{$i2}</a></nobr>&nbsp
				{/foreach}
				{/if}
			{/if}
		</td>
		<td>
			{foreach key=k1 item=i1 from=$i.data name=rn}
				<b>{$smarty.foreach.rn.iteration}.</b>
				{$i1.acceptor_pos_name},
				{$i1.acceptor_department_name},
				<font style="color:red">{$i1.acceptor_name}</font>
				<font style="color:green; font-weight:bold">{$i1.accepted_name}</font>
				{if $i1.accepted_date}<font style="color:blue">{$i1.accepted_date}</font>{/if}
				<br>
			{/foreach}

			{if $i.head.allow_status_change eq 1 and $i.head.report_done}
			<hr>
			Мое согласование:<br>
			{foreach key=k2 item=i2 from=$accept_types}
				<nobr><input type=radio name="bud_ru_zay_accept[{$i.head.current_accept_id}][rep_accepted]" onclick="
						$('#bud_ru_zay_accept_failure_{$i.head.current_accept_id}').attr('disabled',{$i2.id}==2?false:true);
						{$i2.id}==2?null:$('#bud_ru_zay_accept_failure_{$i.head.current_accept_id}').val('');
						" value={$i2.id}>{$i2.name}</nobr><br>
			{/foreach}
			<textarea rows=5 cols=20 disabled required name="bud_ru_zay_accept[{$i.head.current_accept_id}][rep_failure]" id="bud_ru_zay_accept_failure_{$i.head.current_accept_id}"></textarea>
			<script>$("input[name='bud_ru_zay_accept[{$i.head.current_accept_id}][accepted]'][value=0]").attr('checked',true);</script>
			<br>
			<input type="submit" name="save" id="save" value="Сохранить">
			{/if}


		</td>
		<td>
			{foreach key=k1 item=i1 from=$i.data}
				{$i1.failure}<br>
			{/foreach}
		</td>
		<td>
			{if $i.zchat}
			<p>
			Комментарии по {if $smarty.request.tu eq 1}целям на переговоры{else}заявке{/if}:
			<br>
			{foreach key=k1 item=i1 from=$i.zchat}
				{if $i1.zchater_tn eq 1111111111}
				<hr>
				{/if}
				<font style="color:red">{$i1.zchat_time}</font>
				<font style="color:green">{$i1.zchater}:</font>
				<font style="color:blue">{$i1.ztext}</font>
				<br>
			{/foreach}
			</p>
			{/if}
			{if $i.chat}
			<p>
			Комментарии по {if $smarty.request.tu eq 1}торговым условиям{else}отчету{/if}:
			<br>
			{foreach key=k1 item=i1 from=$i.chat}
				{if $i1.chater_tn eq 1111111111}
				<hr>
				{/if}
				<font style="color:red">{$i1.chat_time}</font>
				<font style="color:green">{$i1.chater}:</font>
				<font style="color:blue">{$i1.text|nl2br}</font>
				<br>
			{/foreach}
			</p>
			{/if}
			<p>
			<textarea rows=5 cols=20 name="bud_ru_zay_accept_chat[{$i.head.id}]"></textarea>
			<br>
			<input type="submit" name="add_chat" id="add_chat" value="Добавить">
			</p>
		</td>
	</tr>


	{/foreach}


	<tr style="text-align:left;font-weight:bold">
		<td colspan=11>
		ИТОГО: &nbsp
		{foreach key=k item=i from=$d1}
			{$i.current_status_txt} - {$i.c} &nbsp
		{/foreach}
		</td>
	</tr>







</table>


</form>
<style>
	.open-table-sku {
		display: inline-block;
		cursor: pointer;
		padding: 2px 5px;
		background-color: #eee;
		border-radius: 3px;
		border: 1px solid #b6b6b6;

	}
	.info-sku{
		display: block;
		text-align: center;
		margin: 10px auto;
	}
</style>
<script>
    $(window).load(function(){
        $( ".sku_table" ).each(function(){
            $(this).dialog({
                autoOpen: false,
                modal: true,
                title: "Список SKU по заявке №"+$(this).attr("data-sz-id"),
                //width: $(window).width()*0.5,
                width: 'auto',
                show: {
                    // effect: "clip",
                    duration: 300
                },
                hide: {
                    // effect: "puff",
                    duration: 200
                }
            });
        });

        $( ".open-table-sku" ).on( "click", function() {
            var sz_id = $(this).attr("data-sz-id");
            $( "#sku_table-"+sz_id ).dialog( "open" );
        });
    });
</script>

