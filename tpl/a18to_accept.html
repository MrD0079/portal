<h1>Стандарт - подтверждение {$smarty.request.sd}-{$smarty.request.ed}</h1>

{if not $smarty.request.print}

<form target="_self" method="POST" name=form_report id=form_report>

<p>
Дата
с
<input id=sd name=sd class=datepicker value='{$smarty.request.sd}'>
по
<input id=ed name=ed class=datepicker value='{$smarty.request.ed}'>
</p>

	{if $is_ts neq 1 and $is_eta neq 1}
		<p>
		По руководителю:
		<select name=exp_list_without_ts id=exp_list_without_ts>
			<option value=0></option>
			{foreach key=key item=item from=$exp_list_without_ts}
			<option value={$item.emp_svid}><b>{$item.emp_name}</b> ({$item.emp_pos}) {if $item.datauvol}уволен {$item.datauvol}{/if}</option>
			{/foreach}
		</select>
		</p>
		<p>
		По супервайзеру:
		<select name=exp_list_only_ts id=exp_list_only_ts>
			<option value=0></option>
			{foreach key=key item=item from=$exp_list_only_ts}
			<option value={$item.emp_svid}><b>{$item.emp_name}</b> ({$item.emp_pos}) {if $item.datauvol}уволен {$item.datauvol}{/if}</option>
			{/foreach}
		</select>
		<script>$("#exp_list_without_ts option[value={$smarty.request.exp_list_without_ts}]").prop('selected', true);</script>
		<script>$("#exp_list_only_ts option[value={$smarty.request.exp_list_only_ts}]").prop('selected', true);</script>

		</p>
	{/if}
	{if $is_eta neq 1}
		<p>
		По ЭТА:
		<select name=eta_list id=eta_list>
			<option value=""></option>
			{foreach key=k item=i from=$eta_list}
			<option value="{$i.h_eta}">{$i.eta}</option>
			{/foreach}
		</select>
		<script>$("#eta_list option[value='{$smarty.request.eta_list}']").prop('selected', true);</script>

		</p>
	{/if}
	<p>
	<table border=0>
		<tr>
			<td><input type=radio id="ok_photo" name="ok_photo" value=1>все</td>
			<td><input type=radio id="ok_photo" name="ok_photo" value=2>есть фото</td>
			<td><input type=radio id="ok_photo" name="ok_photo" value=3>нет фото</td>
		</tr>
		<script>$("input[name=ok_photo][value={$smarty.request.ok_photo}]").attr('checked',true);</script>
		<tr>
			<td><input type=radio id="ok_visit" name="ok_visit" value=1>все</td>
			<td><input type=radio id="ok_visit" name="ok_visit" value=2>был визит</td>
			<td><input type=radio id="ok_visit" name="ok_visit" value=3>не было визита</td>
		</tr>
		<script>$("input[name=ok_visit][value={$smarty.request.ok_visit}]").attr('checked',true);</script>
		<tr>
			<td><input type=radio id="ok_ts" name="ok_ts" value=1>все</td>
			<td><input type=radio id="ok_ts" name="ok_ts" value=2>проверил ТС</td>
			<td><input type=radio id="ok_ts" name="ok_ts" value=3>не проверил ТС</td>
		</tr>
		<script>$("input[name=ok_ts][value={$smarty.request.ok_ts}]").attr('checked',true);</script>
		<tr>
			<td><input type=radio id="ok_auditor" name="ok_auditor" value=1>все</td>
			<td><input type=radio id="ok_auditor" name="ok_auditor" value=2>проверил ТМ</td>
			<td><input type=radio id="ok_auditor" name="ok_auditor" value=3>не проверил ТМ</td>
		</tr>
		<script>$("input[name=ok_auditor][value={$smarty.request.ok_auditor}]").attr('checked',true);</script>
		<tr>
			<td><input type=radio id="st_ts" name="st_ts" value=1>все</td>
			<td><input type=radio id="st_ts" name="st_ts" value=2>соответствует стандарту - ТС</td>
			<td><input type=radio id="st_ts" name="st_ts" value=3>не соответствует стандарту - ТС</td>
		</tr>
		<script>$("input[name=st_ts][value={$smarty.request.st_ts}]").attr('checked',true);</script>
		<tr>
			<td><input type=radio id="st_auditor" name="st_auditor" value=1>все</td>
			<td><input type=radio id="st_auditor" name="st_auditor" value=2>соответствует стандарту - ТМ</td>
			<td><input type=radio id="st_auditor" name="st_auditor" value=3>не соответствует стандарту - ТМ</td>
		</tr>
		<script>$("input[name=st_auditor][value={$smarty.request.st_auditor}]").attr('checked',true);</script>
	</table>
	</p>
	<p><input type=submit name=generate id=generate value="Построить отчет"></p>

{if $smarty.request.generate}
	<p><a href="?action=a18to_accept&print=1&excel=1&generate=1&filename=Стандарт - подтверждение {$smarty.request.sd}-{$smarty.request.ed}">Экспорт в Excel</a></p>
{/if}

{/if}

<table style="text-align: center; width:800px;" border=1>
<tbody>
<tr style="font-weight: bold;">
<td>Визитов в ТП с СТО по маршруту ПЛАН</td>
<td>Совершено визитов</td>
<td>ТО</td>
<td style="font-weight: bold; background-color: rgb(255, 204, 153);">Стандарт - ТС</td>
<td style="font-weight: bold; background-color: rgb(255, 204, 153);">Стандарт - ТМ</td>
<td>Не проверено - ТС</td>
<td>Не проверено - ТМ</td>
</tr>
<tr>
<td>{$t.tp_cnt}</td>
<td>{$t.visit_cnt}</td>
<td>{$t1.cto}</td>
<td style="font-weight: bold; background-color: rgb(255, 204, 153);">{$t1.ts}</td>
<td style-weight: bold="font; background-color: rgb(255, 204, 153);">{$t1.auditor}</td>
<td>{$t1.tsnull}</td>
<td>{$t1.auditornull}</td>
</tr>
</tbody>
</table>
<p></p>
<table border=1>
	<tr style="font-weight:bold;text-align:center">
		<td rowspan=2>№ п/п</td>
		<td rowspan=2>Дата визита</td>
		<td rowspan=2>ТС</td>
		<td rowspan=2>ЭТА</td>
		<td rowspan=2>Код ТП</td>
		<td rowspan=2>Название/Адрес ТП</td>
		<td rowspan=2>Тип ТП</td>
		<td rowspan=2>Визит</td>
		<td rowspan=2>ТО</td>
		<td rowspan=2>Фото</td>
		<td rowspan=2>Подтип стандарта</td>
		<td colspan=5>Выполнение стандарта</td>
		<td colspan=2>Задачи</td>
                <td rowspan=2>отг. цел. ассортимент</td>
	</tr>
	<tr style="font-weight:bold;text-align:center">
		<td>ТС</td>
		<td>ТМ</td>
		<td>Коммент ТС</td>
		<td>Коммент ТМ</td>
		<td>Коммент ВСТМ</td>
		<td>ассортимент</td>
		<td>мерчандайзинг</td>
	</tr>
	{foreach key=k item=i from=$d name=d}
			<tr>
				<td rowspan="{$i.cto.cnt+1}">{$smarty.foreach.d.iteration}</td>
				<td rowspan="{$i.cto.cnt+1}">{$i.vd}</td>
				<td rowspan="{$i.cto.cnt+1}">{$i.fio_ts}</td>
				<td rowspan="{$i.cto.cnt+1}">{$i.fio_eta}</td>
				<td rowspan="{$i.cto.cnt+1}">{$i.tp_kod_key}</td>
				<td rowspan="{$i.cto.cnt+1}">{$i.tp_ur} / {$i.tp_addr}</td>
				<td rowspan="{$i.cto.cnt+1}">{$i.tp_type_short}</td>
				<td rowspan="{$i.cto.cnt+1}" style="text-align:center" {if $i.visit eq 0}bgcolor="red"{/if}>{if $i.visit}да{/if}</td>
                                <td></td>
                            {foreach key=k1 item=i1 from=$i.cto.data}
                            <tr>
                                <td style="text-align:center">{$i1.name_to}</td>
				<td>
                                    {foreach key=k2 item=i2 from=$i1.photos}
                                        <a target="_blank" href="{$i2.url}">Фото</a>
                                    {/foreach}
				</td>
                                <td style="text-align:center"
                                    id=td_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}_h_type_standart
                                    >
                                    {$i1.type_standart}
                                </td>
				<td
                                        id=td_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}_ts
                                        {if $i1.ts eq 1}bgcolor="lightgreen"{/if}
                                        {if $i1.ts eq 2}bgcolor="red"{/if}
				>
					{if $i1.ts eq 1}соответствует{/if}
					{if $i1.ts eq 2}не соответствует{/if}
				</td>
				<td
					id=td_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}_auditor
					{if $i1.auditor eq 1}bgcolor="lightgreen"{/if}
					{if $i1.auditor eq 2}bgcolor="red"{/if}
				>
					{if ($is_tm) and not $smarty.request.print}
						<nobr><input type=radio id="auditor_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}" name="auditor_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}" value=1 onClick="save('{$i.visitdate}','{$i.visitdate_key}','{$i.tp_kod_key}','{$i1.h_name_to}','auditor',this.value);save('{$i.visitdate}','{$i.visitdate_key}','{$i.tp_kod_key}','{$i1.h_name_to}','auditor_fio','{$fio}')">соответствует</nobr>
						<br>
						<nobr><input type=radio id="auditor_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}" name="auditor_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}" value=2 onClick="save('{$i.visitdate}','{$i.visitdate_key}','{$i.tp_kod_key}','{$i1.h_name_to}','auditor',this.value);save('{$i.visitdate}','{$i.visitdate_key}','{$i.tp_kod_key}','{$i1.h_name_to}','auditor_fio','{$fio}')">не соответствует</nobr>
						<script>$("input[name=auditor_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}][value='{$i1.auditor}']").attr('checked',true);</script>
					{else}
						{if $i1.auditor eq 1}соответствует{/if}
						{if $i1.auditor eq 2}не соответствует{/if}
					{/if}
					{if $i1.auditor}<br>{/if}{$i1.auditor_fio} {$i1.auditor_lu}
				</td>
				<td>
					{$i1.ts_comm|nl2br}
				</td>
				<td id=td_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}_auditor_comm>
					{if ($is_tm) and not $smarty.request.print}
						<textarea id="auditor_comm_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}"
                                                          name="auditor_comm_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}"
                                                          onChange="save('{$i.visitdate}','{$i.visitdate_key}','{$i.tp_kod_key}','{$i1.h_name_to}','auditor_comm',this.value)">{$i1.auditor_comm}</textarea>
					{else}
						{$i1.auditor_comm|nl2br}
					{/if}
				</td>
				<td id=td_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}_traid_comm>
					{if ($is_traid) and not $smarty.request.print}
						<textarea
							id="traid_comm_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}"
							name="traid_comm_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}"
						>{$i1.traid_comm}</textarea>
						<br>
						<a
							href="javascript:void(0);"
							onClick="
                                                            save(
                                                            '{$i.visitdate}'
                                                            ,'{$i.visitdate_key}'
                                                            ,'{$i.tp_kod_key}'
                                                            ,'{$i1.h_name_to}'
                                                            ,'traid_comm'
                                                            ,$('#traid_comm_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}').val()
                                                            ,'traid'
                                                            ,$('#cb_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}_traid').prop('checked')?1:0
                                                            );
                                                        "
						>Сохранить</a>
                                                &nbsp;
                                                <div style="display: inline; /*{if $i1.traid eq 1}*/background-color:red;/*{/if}*/"
                                                     id="td_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}_traid">
                                                <input
                                                    type="checkbox"
                                                    id="cb_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}_traid"
                                                       > отк. станд
                                                </div>
                                                <script>$("#cb_{$i.visitdate_key}_{$i.tp_kod_key}_{$i1.h_name_to}_traid").prop('checked','{$i1.traid}'=='1'?true:false);</script>
					{else}
						{$i1.traid_comm|nl2br}
                                                {if $i1.traid eq 1}&nbsp;<div style="display: inline; background-color:red;">отк. станд</div>{/if}
					{/if}
				</td>
				<td>{$i1.tasks_assort|nl2br}</td>
				<td>{$i1.tasks_mr|nl2br}</td>
                                <td>
                                    <div class="pics">{$i1.target}<div class="hov">{$i1.target_info|nl2br}</div></div>
                                </td>
                            </tr>
                            {/foreach}
			</tr>
	{/foreach}
</table>

{if not $smarty.request.print}

</form>

<script>
/*{literal}*/
function save(visitdate,visitdate_key,tp_kod,h_name_to,field,val,field1,val1)
{
$('#td_'+visitdate_key+'_'+tp_kod+'_'+h_name_to+'_'+field).css('background-color','red');
var fd = new FormData();
fd.append('visitdate',  visitdate);
fd.append('tp_kod',  tp_kod);
fd.append('h_name_to',  h_name_to);
fd.append('field',  field);
fd.append('val',  val);
fd.append('field1',  field1);
fd.append('val1',  val1);
/*console.log(visitdate);
console.log(visitdate_key);
console.log(tp_kod);
console.log(h_name_to);
console.log(field);
console.log(val);
console.log(field1);
console.log(val1);*/
$.ajax({
  type: 'POST',
  url: '?action=a18to_accept&save=1&nohead=1',
  data: fd,
  processData: false,
  contentType: false,
  success: function(data) {
   $('#td_'+visitdate_key+'_'+tp_kod+'_'+h_name_to+'_'+field).css('background-color','white');
   $('#td_'+visitdate_key+'_'+tp_kod+'_'+h_name_to+'_'+field1).css('background-color','white');
   if (field=='auditor')
   {
    (val==1) ? $('#td_'+visitdate_key+'_'+tp_kod+'_'+h_name_to+'_'+field).css('background-color','lightgreen') : null;
    (val==2) ? $('#td_'+visitdate_key+'_'+tp_kod+'_'+h_name_to+'_'+field).css('background-color','red') : null;
   }
   if (field1=='traid')
   {
    (val1==1) ? $('#td_'+visitdate_key+'_'+tp_kod+'_'+h_name_to+'_'+field1).css('background-color','red') : null;
   }
   //console.log(data);
  }
});
}
/*{/literal}*/
</script>

{/if}